<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ Панел</title>

    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        body { font-family: 'Ubuntu', sans-serif; background: #f4f6f8; margin: 0; padding: 0; }
        header { background: #3d85c6; color: #fff; padding: 15px 20px; }
        .container { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        input, select { width: 100%; padding: 8px; margin: 8px 0; border-radius: 8px; box-sizing: border-box; }
        .list-item { padding: 8px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; }
        #editor { height: 150px; }
        .group-title { font-weight: bold; margin-top: 20px; color: #3d85c6; }
        .search-input { margin-bottom: 10px; padding: 8px; width: 100%; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;}
        .checkbox-group { display: flex; gap: 20px; margin: 10px 0; }
    </style>
</head>
<body>

<header><h1>Админ Панел</h1></header>

<div class="container">

    <div class="card">
        <h2>Мэдээ нэмэх / засах</h2>
        <input type="hidden" id="editIndex">
        <input id="newsTitle" placeholder="Гарчиг">
        <select id="newsCategory">
            <option value="">Ангилал</option>
            <option>Улс төр</option>
            <option>Эдийн засаг</option>
            <option>Соёл урлаг</option>
            <option>Медиа</option>
            <option>Дэлхий дахинд</option>
            <option>Ярилцлага</option>
        </select>
        <input id="newsImage" placeholder="Зураг URL">
        <div id="editor"></div>
        <select id="newsAuthor"></select>
        
        <div class="checkbox-group">
            <label><input type="checkbox" id="newsFeatured"> Онцлох</label>
            <label><input type="checkbox" id="newsActive"> Идэвхтэй / Нийтлэх</label> 
        </div>
        
        <button onclick="saveNews()">Хадгалах</button>
        <button onclick="clearNewsForm()">Цэвэрлэх</button>
    </div>

    <div class="card">
        <h2>Нийтлэлч</h2>
        <input type="hidden" id="editAuthorIndex">
        <input id="authorName" placeholder="Нэр">
        <input id="authorTitle" placeholder="Албан тушаал">
        <input id="authorImage" placeholder="Зураг">
        <button onclick="saveAuthor()">Хадгалах</button>
        <button onclick="clearAuthorForm()">Цэвэрлэх</button>
    </div>

    <div class="card" style="grid-column: span 2;">
        <input type="text" id="searchInput" class="search-input" placeholder="Мэдээ хайх...">
    </div>

    <div class="card" style="grid-column: span 2;">
        <h2>Мэдээ</h2>
        <div id="newsList"></div>
    </div>

    <div class="card" style="grid-column: span 2;">
        <h2>Нийтлэлчид</h2>
        <div id="authorList"></div>
    </div>

</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 

<script>
// DOM элементүүд
const newsTitle = document.getElementById("newsTitle");
const newsCategory = document.getElementById("newsCategory");
const newsImage = document.getElementById("newsImage");
const newsAuthor = document.getElementById("newsAuthor");
const newsFeatured = document.getElementById("newsFeatured");
const newsActive = document.getElementById("newsActive"); 
const newsList = document.getElementById("newsList");
const editIndex = document.getElementById("editIndex");

const authorName = document.getElementById("authorName");
const authorTitle = document.getElementById("authorTitle");
const authorImage = document.getElementById("authorImage");
const editAuthorIndex = document.getElementById("editAuthorIndex");
const authorList = document.getElementById("authorList");

const searchInput = document.getElementById("searchInput");

// Supabase client (window.supabase-ийг ашиглаж байна)
const supabaseUrl = "https://wpotnvekaoosdkvmhqgo.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indwb3RudmVrYW9vc2Rrdm1ocWdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTU3NjQsImV4cCI6MjA4MDU5MTc2NH0.YIpy_IA9nNseYUJB3Y-adxgv9btgAt5IKP5FJpafNC0";

// ✅ ЗАСВАР: window.supabase-аас createClient-г авч ашиглаж байна.
const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey); 

// Quill editor
const quill = new Quill("#editor", { theme: "snow" });

// ---------------------------------------------------
// AUTHORS
// ---------------------------------------------------
async function fetchAuthors() {
    const { data } = await supabaseClient.from("authors").select("*").order("id");
    return data || [];
}

async function populateAuthorSelect() {
    const list = await fetchAuthors();
    newsAuthor.innerHTML = list.length
        ? list.map(a => `<option value="${a.id}">${a.name}</option>`).join("")
        : `<option disabled>Нийтлэлч байхгүй</option>`;
}

async function displayAuthors() {
    const list = await fetchAuthors();
    authorList.innerHTML = list.length
        ? list.map(a => `<br>
            <div class="list-item"><br>
                <span>${a.name} (${a.title})</span><br>
                <span><br>
                    <button onclick="editAuthor(${a.id})">Засах</button><br>
                    <button onclick="removeAuthor(${a.id})">Устгах</button><br>
                </span><br>
            </div><br>
        `).join("")
        : "Нийтлэлч байхгүй";
}

async function saveAuthor() {
    const data = {
        name: authorName.value.trim(),
        title: authorTitle.value.trim(),
        image: authorImage.value.trim()
    };
    if (!data.name) return alert("Нэр заавал бөглөнө");

    if (editAuthorIndex.value === "")
        await supabaseClient.from("authors").insert(data);
    else
        await supabaseClient.from("authors").update(data).eq("id", editAuthorIndex.value);

    clearAuthorForm();
    populateAuthorSelect();
    displayAuthors();
}

async function editAuthor(id) {
    const { data } = await supabaseClient.from("authors").select("*").eq("id", id).single();
    editAuthorIndex.value = data.id;
    authorName.value = data.name;
    authorTitle.value = data.title;
    authorImage.value = data.image;
}

async function removeAuthor(id) {
    if (confirm("Устгах уу?")) {
        await supabaseClient.from("authors").delete().eq("id", id);
        populateAuthorSelect();
        displayAuthors();
    }
}

function clearAuthorForm() {
    editAuthorIndex.value = "";
    authorName.value = "";
    authorTitle.value = "";
    authorImage.value = "";
}

// ---------------------------------------------------
// NEWS
// ---------------------------------------------------
async function fetchNews() {
    const { data } = await supabaseClient.from("news").select("*").order("created_at", { ascending: false });
    return data || [];
}

function generateSlug(title) {
    // Монгол үсгээр dash-аар тусгаарласан slug үүсгэнэ
    return title.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]+/g, '');
}

async function displayNews(filter = "") {
    const news = await fetchNews();
    const authors = await fetchAuthors();
    newsList.innerHTML = "";

    let filteredNews = news;
    if (filter) {
        filteredNews = news.filter(n => n.title.toLowerCase().includes(filter.toLowerCase()));
    }

    if (!filteredNews.length) { newsList.innerHTML = "Мэдээ байхгүй"; return; }

    const grouped = {};
    filteredNews.forEach(n => {
        const day = n.created_at ? n.created_at.split("T")[0] : "Огноо байхгүй";
        if (!grouped[day]) grouped[day] = [];
        grouped[day].push(n);
    });

    for (const d in grouped) {
        newsList.innerHTML += `<div class="group-title">${d}</div>`;
        grouped[d].forEach(n => {
            const aut = authors.find(a => a.id == n.author_id)?.name || "Тодорхойгүй";
            const activeStatus = n.active ? " (Идэвхтэй)" : " (Ноорог)"; 
            
            // Slug байхгүй бол анхааруулга өгнө
            const slugStatus = !n.slug ? " ⚠️ SLUG АЛГА" : "";

            newsList.innerHTML += `<br>
            <div class="list-item"><br>
                <span>${n.title} | ${n.category} | ${aut} ${n.featured ? " | Онцлох" : ""} ${activeStatus}${slugStatus}</span><br>
                <span><br>
                    <button onclick="editNews(${n.id})">Засах</button><br>
                    <button onclick="removeNews(${n.id})">Устгах</button><br>
                </span><br>
            </div>`;
        });
    }
}

async function saveNews() {
    const html = quill.root.innerHTML.trim();
    const titleValue = newsTitle.value.trim();
    
    const data = {
        title: titleValue,
        // ✅ SLUG-ИЙГ ҮҮСГЭЖ БАЙНА
        slug: generateSlug(titleValue), 
        category: newsCategory.value || null,
        image: newsImage.value.trim() || null,
        description: html || null,
        author_id: newsAuthor.value ? Number(newsAuthor.value) : null,
        featured: newsFeatured.checked,
        // ✅ ACTIVE УТГЫГ ИЛГЭЭЖ БАЙНА
        active: newsActive.checked 
    };
    if (!data.title) return alert("Гарчиг заавал бөглөнө");
    if (!data.author_id) return alert("Нийтлэлч сонгоно уу");

    let result;
    if (editIndex.value === "") {
        // Шинэ мэдээ нэмэх
        result = await supabaseClient.from("news").insert(data);
    } else {
        // Мэдээ засах
        result = await supabaseClient.from("news").update(data).eq("id", editIndex.value);
    }
    
    if (result.error) {
        console.error("News save error:", result.error);
        alert(`Мэдээ хадгалахад алдаа гарлаа: ${result.error.message}. Slug давхардсан эсэхийг шалгана уу.`);
    } else {
        alert("Мэдээ амжилттай хадгалагдлаа.");
    }

    clearNewsForm();
    displayNews(searchInput.value);
}

async function editNews(id) {
    const { data } = await supabaseClient.from("news").select("*").eq("id", id).single();
    editIndex.value = data.id;
    newsTitle.value = data.title;
    newsCategory.value = data.category;
    newsImage.value = data.image;
    newsAuthor.value = data.author_id;
    newsFeatured.checked = data.featured;
    newsActive.checked = data.active; 
    quill.root.innerHTML = data.description;
}

async function removeNews(id) {
    if (confirm("Устгах уу?")) {
        await supabaseClient.from("news").delete().eq("id", id);
        displayNews(searchInput.value);
    }
}

function clearNewsForm() {
    editIndex.value = "";
    newsTitle.value = "";
    newsCategory.value = "";
    newsImage.value = "";
    newsFeatured.checked = false;
    newsActive.checked = false; 
    quill.setText("");
}

// Search listener
searchInput.addEventListener("input", () => {
    displayNews(searchInput.value);
});

// Global scope-д функцуудыг гаргах (onclick үйлдэл ажиллахын тулд)
window.saveNews = saveNews;
window.clearNewsForm = clearNewsForm;
window.editNews = editNews;
window.removeNews = removeNews;
window.saveAuthor = saveAuthor;
window.clearAuthorForm = clearAuthorForm;
window.editAuthor = editAuthor;
window.removeAuthor = removeAuthor;

// INIT
populateAuthorSelect();
displayAuthors();
displayNews();
</script>
</body>
</html>
