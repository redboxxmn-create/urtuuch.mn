<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ Панел</title>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tiny.cloud/1/0xo8rrnri5u1551x3vo90d2zedgkawbi24elx29pv7txbd0n/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
    
    <style>
        body { font-family: 'Ubuntu', sans-serif; margin: 0; padding: 0; background: #f0f5f5; color: #333; }
        header { background: #3d85c6; color: #fff; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        header h1 { margin: 0; font-size: 24px; }
        .logout-btn { background: #d9534f; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; transition: background 0.3s; }
        .logout-btn:hover { background: #c9302c; }

        .container { display: flex; padding: 20px; }
        .sidebar { width: 250px; padding: 15px; background: #fff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-right: 20px; }
        .sidebar button { width: 100%; padding: 10px; margin-bottom: 10px; background: #6fa8dc; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background 0.3s; font-weight: bold; }
        .sidebar button.active, .sidebar button:hover { background: #3d85c6; }

        .content { flex-grow: 1; background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Мэдээний картны жагсаалт */
        .news-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .news-list-item:hover { background: #f9f9f9; }
        .news-title { flex-grow: 1; font-weight: 500; }
        .news-actions button { margin-left: 10px; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; transition: background 0.3s; }
        .edit-btn { background: #5cb85c; color: white; }
        .delete-btn { background: #f0ad4e; color: white; }
        .edit-btn:hover { background: #4cae4c; }
        .delete-btn:hover { background: #eea236; }

        /* Мэдээ нэмэх/засах талбар */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
        .form-group textarea { resize: vertical; }

        .form-actions button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.3s; }
        #saveNewsBtn, #saveSettingsBtn { background: #3d85c6; color: white; }
        #saveNewsBtn:hover, #saveSettingsBtn:hover { background: #337ab7; }
        #cancelEditBtn { background: #ccc; color: #333; margin-left: 10px; }
        #cancelEditBtn:hover { background: #bbb; }
        
        /* Featured & Active Checkboxes */
        .checkbox-group { display: flex; gap: 20px; margin-top: 10px; }
        .checkbox-group label { font-weight: normal; }

        /* Response message */
        #responseMessage, #settingsResponseMessage { margin-top: 20px; padding: 10px; border-radius: 6px; font-weight: bold; display: none; }
        .success { background-color: #dff0d8; color: #3c763d; border: 1px solid #d6e9c6; }
        .error { background-color: #f2dede; color: #a94442; border: 1px solid #ebccd1; }
    </style>
</head>
<body>
<header>
    <h1>Админ Панел</h1>
    <button class="logout-btn" onclick="logout()">Гарах</button>
</header>

<div class="container">
    <div class="sidebar">
        <button id="tabListNews" onclick="openTab('listNews', this)" class="active">Мэдээний жагсаалт</button>
        <button id="tabCreateNews" onclick="openTab('createNews', this)">Мэдээ нэмэх</button>
        <button id="tabSettings" onclick="openTab('settings', this)">Тохиргоо</button>
    </div>

    <div class="content">
        <div id="listNews" class="tab-content active">
            <h2>Нийтлэгдсэн мэдээ (29 мэдээ)</h2>
            <div id="newsListContainer">
                <p>Мэдээ татаж байна...</p>
            </div>
        </div>

        <div id="createNews" class="tab-content">
            <h2 id="newsFormTitle">Мэдээ нэмэх</h2>
            <div class="form-group">
                <label for="newsTitle">Гарчиг:</label>
                <input type="text" id="newsTitle" oninput="generateSlug()" required>
            </div>
            
            <div class="form-group">
                <label for="newsSlug">Slug (URL-ийн нэр):</label>
                <input type="text" id="newsSlug" required>
            </div>
            
            <div class="form-group">
                <label for="newsAuthor">Нийтлэлч:</label>
                <select id="newsAuthor" required>
                    </select>
            </div>
            
            <div class="form-group">
                <label for="newsCategory">Ангилал:</label>
                <select id="newsCategory" onchange="fetchSubCategories(this.value)" required>
                    <option value="">Ангилал сонгоно уу</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="newsSubCategory">Дэд Ангилал:</label>
                <select id="newsSubCategory" required>
                    <option value="">Дэд Ангилал сонгоно уу</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="newsImage">Зургийн URL:</label>
                <input type="url" id="newsImage" placeholder="https://image-url.com/example.jpg">
            </div>

            <div class="form-group">
                <label for="newsContent">Агуулга:</label>
                <textarea id="newsContent" rows="15"></textarea>
            </div>
            
            <div class="form-group checkbox-group">
                <div>
                    <input type="checkbox" id="newsFeatured">
                    <label for="newsFeatured">Онцлох мэдээ (Featured)</label>
                </div>
                <div>
                    <input type="checkbox" id="newsActive" checked>
                    <label for="newsActive">Нийтлэх (Active)</label>
                </div>
            </div>

            <div class="form-actions">
                <button id="saveNewsBtn" onclick="saveNews(true)">Хадгалах</button>
                <button id="cancelEditBtn" onclick="openTab('listNews')">Буцах</button>
            </div>
            <input type="hidden" id="newsId"> 
            <div id="responseMessage"></div>
        </div>
        
        <div id="settings" class="tab-content">
            <h2>Сайтын Үндсэн Тохиргоо</h2>
            <div class="form-group">
                <label for="mainVideoUrl">Үндсэн Хуудасны Видео URL (YouTube Embed):</label>
                <input type="url" id="mainVideoUrl" placeholder="https://www.youtube.com/embed/XXXXXXX">
                <small style="color:#666;">Зөвхөн YouTube-ийн **Embed** холбоосыг оруулна.</small>
            </div>
            <div class="form-actions">
                <button id="saveSettingsBtn" onclick="saveSettings()">Тохиргоог Хадгалах</button>
            </div>
            <div id="settingsResponseMessage"></div>
        </div>

    </div>
</div>

<script type="module">
// Supabase-ийн JS импорт
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.0/+esm';

// ************************************************************
// ТАНЫ SUPABASE ТҮЛХҮҮРҮҮД
// ************************************************************
const SUPABASE_URL = "https://wpotnvekaoosdkvmhqgo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indwb3RudmVrYW9vc2Rrdm1ocWdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTU3NjQsImV4cCI6MjA4MDU5MTc2NH0.YIpy_IA9nNseYUJB3Y-adxgv9btgAt5IKP5FJpafNC0";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true }, 
});


// ************************************************************
// 1. ЕРӨНХИЙ АЧААЛАЛТ
// ************************************************************

window.onload = function() {
    fetchNewsList();
    fetchAuthors();      // ✅ Зохиогчдыг татах
    fetchCategories();   // ✅ Ангиллуудыг татах
};

// ************************************************************
// 2. АНГИЛАЛ БА ЗОХИОГЧ ТАТАХ
// ************************************************************

/**
 * Зохиогчдыг Supabase-аас татаж SELECT талбарыг дүүргэх
 */
async function fetchAuthors() {
    // Таны Supabase дахь зохиогчдын хүснэгтийн нэрийг 'authors' гэж тооцов.
    const { data, error } = await supabase
        .from('authors') 
        .select('id, name')
        .order('name', { ascending: true });

    const select = document.getElementById('newsAuthor');
    select.innerHTML = '<option value="">Нийтлэлч сонгоно уу</option>'; // Эхний хоосон утга

    if (error) {
        console.error("Зохиогч татахад алдаа гарлаа:", error);
        return;
    }

    data.forEach(author => {
        const option = document.createElement('option');
        option.value = author.id;
        option.textContent = author.name;
        select.appendChild(option);
    });
}

/**
 * Ангиллуудыг татаж SELECT талбарыг дүүргэх
 */
async function fetchCategories() {
    const { data, error } = await supabase
        .from('categories') 
        .select('id, name')
        .order('name', { ascending: true });

    const select = document.getElementById('newsCategory');
    select.innerHTML = '<option value="">Ангилал сонгоно уу</option>';

    if (error) {
        console.error("Ангилал татахад алдаа гарлаа:", error);
        return;
    }

    data.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        select.appendChild(option);
    });
}

/**
 * Ангилал сонгоход хамаарах дэд ангиллуудыг татаж дүүргэх
 */
window.fetchSubCategories = async function(categoryId) {
    const select = document.getElementById('newsSubCategory');
    select.innerHTML = '<option value="">Дэд Ангилал сонгоно уу</option>'; // Reset

    if (!categoryId) return;
    
    // Таны Supabase дахь дэд ангиллын хүснэгтийг 'sub_categories' гэж тооцов.
    const { data, error } = await supabase
        .from('sub_categories') 
        .select('id, name')
        .eq('category_id', categoryId)
        .order('name', { ascending: true });

    if (error) {
        console.error("Дэд ангилал татахад алдаа гарлаа:", error);
        return;
    }

    data.forEach(subCategory => {
        const option = document.createElement('option');
        option.value = subCategory.id;
        option.textContent = subCategory.name;
        select.appendChild(option);
    });
}

// ************************************************************
// 3. SLUG АВТОМАТААР ҮҮСГЭХ
// ************************************************************

/**
 * Кирилл үсгийг Латин үсэгт хөрвүүлж, slug үүсгэх функц
 */
window.generateSlug = function() {
    const title = document.getElementById('newsTitle').value;
    const slugInput = document.getElementById('newsSlug');
    
    // Кирилл - Латин хөрвүүлэгч (Хялбаршуулсан)
    const cyrillicToLatinMap = {
        'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'yo', 'ж': 'zh',
        'з': 'z', 'и': 'i', 'й': 'i', 'к': 'k', 'л': 'l', 'м': 'm', 'н': 'n', 'о': 'o',
        'ө': 'o', 'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u', 'ү': 'u', 'ф': 'f',
        'х': 'kh', 'ц': 'ts', 'ч': 'ch', 'ш': 'sh', 'щ': 'sch', 'ъ': '', 'ы': 'y', 'ь': '',
        'э': 'e', 'ю': 'yu', 'я': 'ya'
    };
    
    let slug = title.toLowerCase();

    // Кирилл хөрвүүлэлт
    slug = slug.split('').map(char => cyrillicToLatinMap[char] || char).join('');
    
    // Зай болон бусад тэмдэгтийг орлуулах
    slug = slug.replace(/[^a-z0-9\s-]/g, '') // Латин үсэг, тоо, зай, зурааснаас бусдыг арилгах
               .trim()                      // Хоосон зайг арилгах
               .replace(/\s+/g, '-')        // Хоосон зайг зураасаар солих
               .replace(/-+/g, '-');        // Давхардсан зураасыг нэг зураасаар солих

    slugInput.value = slug;
}

// ************************************************************
// 4. TINYMCE-ИЙГ ИДЭВХЖҮҮЛЭХ
// ************************************************************

tinymce.init({
    selector: '#newsContent', 
    plugins: 'advlist autolink lists link image charmap print preview anchor code', 
    toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | link image | code', 
    menubar: 'file edit view insert format tools table help',
    height: 500,
    setup: function(editor) {
        editor.on('init', function() {
            const contentElement = document.getElementById('newsContent');
            if(contentElement.value) {
                editor.setContent(contentElement.value);
            }
        });
    }
});


// ************************************************************
// 5. МЭДЭЭНИЙ ФУНКЦҮҮД (FETCH, SAVE, DELETE)
// ************************************************************
// fetchNewsList, editNews, deleteNews функцууд өмнөхөөрөө үргэлжилнэ
async function fetchNewsList() {
    // ... (Өмнөх код) ...
    const { data, error } = await supabase
        .from('news')
        .select('id, title, created_at, active, slug')
        .order('created_at', { ascending: false })
        .limit(29); 
        // ... (Үлдсэн код) ...
}
window.editNews = async function(slug) {
    // ... (Өмнөх код) ...
    const { data, error } = await supabase
        .from('news')
        .select('*')
        .eq('slug', slug)
        .single();

    if (error) {
        showMessage(`Мэдээ татахад алдаа гарлаа: ${error.message}`, 'error');
        return;
    }

    // ... (Бусад талбаруудыг дүүргэх) ...
    document.getElementById('newsId').value = data.id;
    // ...
    // ✅ Зохиогчийг сонгох
    document.getElementById('newsAuthor').value = data.author_id || ''; 
    
    // ✅ Ангиллыг сонгох
    if (data.category_id) {
        document.getElementById('newsCategory').value = data.category_id;
        // Дэд ангиллыг татаж дүүргэх
        await fetchSubCategories(data.category_id); 
        document.getElementById('newsSubCategory').value = data.sub_category_id || '';
    } else {
        document.getElementById('newsCategory').value = '';
        fetchSubCategories('');
    }
    // ... (Үлдсэн код) ...

    openTab('createNews');
};


window.saveNews = async function(isNew) {
    
    const content = tinymce.get('newsContent').getContent();
    
    const newsId = document.getElementById('newsId').value;
    const title = document.getElementById('newsTitle').value;
    const slug = document.getElementById('newsSlug').value;
    const authorId = document.getElementById('newsAuthor').value; // ✅ Шинэ: author_id
    const categoryId = document.getElementById('newsCategory').value; // ✅ Шинэ: category_id
    const subCategoryId = document.getElementById('newsSubCategory').value; // ✅ Шинэ: sub_category_id
    const image = document.getElementById('newsImage').value;
    const featured = document.getElementById('newsFeatured').checked;
    const active = document.getElementById('newsActive').checked;
    
    if (!title || !slug || !content || !authorId || !categoryId || !subCategoryId) {
        showMessage('Гарчиг, Slug, Агуулга, Нийтлэлч, Ангиллыг бүрэн бөглөнө үү.', 'error');
        return;
    }

    const newsData = {
        title: title,
        slug: slug,
        author_id: authorId,           // ✅ Шинэ: author_id
        category_id: categoryId,       // ✅ Шинэ: category_id
        sub_category_id: subCategoryId,// ✅ Шинэ: sub_category_id
        image: image || null,
        content: content, 
        featured: featured,
        active: active,
    };

    let response;
    
    if (isNew) {
        response = await supabase.from('news').insert([newsData]);
    } else {
        response = await supabase.from('news').update(newsData).eq('id', newsId);
    }
    
    if (response.error) {
        showMessage(`Хадгалахад алдаа гарлаа: ${response.error.message}`, 'error');
    } else {
        showMessage(isNew ? 'Мэдээ амжилттай нэмэгдлээ!' : 'Мэдээ амжилттай шинэчлэгдлээ!', 'success');
        resetNewsForm();
        fetchNewsList();
        openTab('listNews');
    }
};

window.deleteNews = async function(id) {
    // ... (Өмнөх код) ...
}

// ************************************************************
// 6. ТОХИРГООНЫ ФУНКЦҮҮД (ВИДЕО)
// ************************************************************

async function fetchSettings() {
    // ... (Өмнөх код) ...
}

window.saveSettings = async function() {
    // ... (Өмнөх код) ...
}

// ************************************************************
// 7. ТУСЛАХ ФУНКЦҮҮД
// ************************************************************
window.openTab = function(tabName, elm) {
    // ... (Өмнөх код) ...
    // Тохиргооны таб руу шилжих үед утгыг татна
    if (tabName === 'settings') {
        fetchSettings();
    }
    
    if (tabName !== 'createNews') {
        resetNewsForm();
    }
    
    document.getElementById('responseMessage').style.display = 'none';
    document.getElementById('settingsResponseMessage').style.display = 'none';
};

function resetNewsForm() {
    document.getElementById('newsId').value = '';
    document.getElementById('newsFormTitle').innerText = 'Мэдээ нэмэх';
    document.getElementById('newsTitle').value = '';
    document.getElementById('newsSlug').value = '';
    document.getElementById('newsImage').value = '';
    document.getElementById('newsAuthor').value = ''; // ✅ Шинэ: author_id-г reset хийх
    document.getElementById('newsCategory').value = ''; // ✅ Шинэ: category_id-г reset хийх
    document.getElementById('newsSubCategory').innerHTML = '<option value="">Дэд Ангилал сонгоно уу</option>'; // ✅ Шинэ: sub_category-г reset хийх
    document.getElementById('newsFeatured').checked = false;
    document.getElementById('newsActive').checked = true;
    
    if (tinymce.get('newsContent')) {
        tinymce.get('newsContent').setContent('');
    }
    document.getElementById('saveNewsBtn').onclick = () => saveNews(true);
    document.getElementById('saveNewsBtn').innerText = 'Хадгалах';
}

function showMessage(message, type, elementId = 'responseMessage') {
    // ... (Өмнөх код) ...
}

window.logout = function() {
    // ... (Өмнөх код) ...
};
</script>
</body>
</html>
