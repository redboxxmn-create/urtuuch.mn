<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ Панел</title>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
    <style>
        body { font-family: 'Ubuntu', sans-serif; margin: 0; padding: 0; background: #f0f5f5; color: #333; }
        header { background: #3d85c6; color: #fff; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        header h1 { margin: 0; font-size: 24px; }
        .logout-btn { background: #d9534f; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; transition: background 0.3s; }
        .logout-btn:hover { background: #c9302c; }

        .container { display: flex; padding: 20px; }
        .sidebar { width: 250px; padding: 15px; background: #fff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-right: 20px; }
        .sidebar button { width: 100%; padding: 10px; margin-bottom: 10px; background: #6fa8dc; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background 0.3s; font-weight: bold; }
        .sidebar button.active, .sidebar button:hover { background: #3d85c6; }

        .content { flex-grow: 1; background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Мэдээний картны жагсаалт */
        .news-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .news-list-item:hover { background: #f9f9f9; }
        .news-title { flex-grow: 1; font-weight: 500; }
        .news-actions button { margin-left: 10px; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; transition: background 0.3s; }
        .edit-btn { background: #5cb85c; color: white; }
        .delete-btn { background: #f0ad4e; color: white; }
        .edit-btn:hover { background: #4cae4c; }
        .delete-btn:hover { background: #eea236; }

        /* Мэдээ нэмэх/засах талбар */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
        .form-group textarea { resize: vertical; }

        .form-actions button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.3s; }
        #saveNewsBtn { background: #3d85c6; color: white; }
        #saveNewsBtn:hover { background: #337ab7; }
        #cancelEditBtn { background: #ccc; color: #333; margin-left: 10px; }
        #cancelEditBtn:hover { background: #bbb; }
        
        /* Featured & Active Checkboxes */
        .checkbox-group { display: flex; gap: 20px; margin-top: 10px; }
        .checkbox-group label { font-weight: normal; }

        /* Response message */
        #responseMessage { margin-top: 20px; padding: 10px; border-radius: 6px; font-weight: bold; display: none; }
        .success { background-color: #dff0d8; color: #3c763d; border: 1px solid #d6e9c6; }
        .error { background-color: #f2dede; color: #a94442; border: 1px solid #ebccd1; }
    </style>
</head>
<body>
<header>
    <h1>Админ Панел</h1>
    <button class="logout-btn" onclick="logout()">Гарах</button>
</header>

<div class="container">
    <div class="sidebar">
        <button id="tabListNews" onclick="openTab('listNews', this)" class="active">Мэдээний жагсаалт</button>
        <button id="tabCreateNews" onclick="openTab('createNews', this)">Мэдээ нэмэх</button>
        </div>

    <div class="content">
        <div id="listNews" class="tab-content active">
            <h2>Нийтлэгдсэн мэдээ (29 мэдээ)</h2>
            <div id="newsListContainer">
                <p>Мэдээ татаж байна...</p>
            </div>
        </div>

        <div id="createNews" class="tab-content">
            <h2 id="newsFormTitle">Мэдээ нэмэх</h2>
            <div class="form-group">
                <label for="newsTitle">Гарчиг:</label>
                <input type="text" id="newsTitle" required>
            </div>
            
            <div class="form-group">
                <label for="newsSlug">Slug (URL-ийн нэр):</label>
                <input type="text" id="newsSlug" required>
            </div>
            
            <div class="form-group">
                <label for="newsCategory">Ангилал:</label>
                <select id="newsCategory">
                    <option value="Улс төр">Улс төр</option>
                    <option value="Эдийн засаг">Эдийн засаг</option>
                    <option value="Соёл урлаг">Соёл урлаг</option>
                    <option value="Спорт">Спорт</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="newsImage">Зургийн URL:</label>
                <input type="url" id="newsImage" placeholder="https://image-url.com/example.jpg">
            </div>

            <div class="form-group">
                <label for="newsContent">Агуулга:</label>
                <textarea id="newsContent" rows="15"></textarea>
            </div>
            
            <div class="form-group checkbox-group">
                <div>
                    <input type="checkbox" id="newsFeatured">
                    <label for="newsFeatured">Онцлох мэдээ (Featured)</label>
                </div>
                <div>
                    <input type="checkbox" id="newsActive" checked>
                    <label for="newsActive">Нийтлэх (Active)</label>
                </div>
            </div>

            <div class="form-actions">
                <button id="saveNewsBtn" onclick="saveNews(true)">Хадгалах</button>
                <button id="cancelEditBtn" onclick="openTab('listNews')">Буцах</button>
            </div>
            <input type="hidden" id="newsId"> <div id="responseMessage"></div>
        </div>
    </div>
</div>

<script type="module">
// Supabase-ийн JS импорт
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.0/+esm';

// ************************************************************
// ТАНЫ SUPABASE ТҮЛХҮҮРҮҮД
// ************************************************************
const SUPABASE_URL = "https://wpotnvekaoosdkvmhqgo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indwb3RudmVrYW9vc2Rrdm1ocWdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTU3NjQsImV4cCI6MjA4MDU5MTc2NH0.YIpy_IA9nNseYUJB3Y-adxgv9btgAt5IKP5FJpafNC0";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true }, // СЕССИЙГ ХАДГАЛАХ
});

let currentNewsId = null; // Засах үед ашиглана

// ************************************************************
// ✅ TINYMCE-ИЙГ ИДЭВХЖҮҮЛЭХ
// ************************************************************
tinymce.init({
    selector: '#newsContent', 
    plugins: 'advlist autolink lists link image charmap print preview anchor code', 
    toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | link image | code', 
    menubar: 'file edit view insert format tools table help',
    height: 500,
    // setup функц нь мэдээг засах үед TinyMCE-ийн утгыг зөв ачаална
    setup: function(editor) {
        editor.on('init', function() {
            // Мэдээг засах үед утгыг автоматаар ачаална
            const contentElement = document.getElementById('newsContent');
            if(contentElement.value) {
                editor.setContent(contentElement.value);
            }
        });
    }
});

// ************************************************************
// 1. МЭДЭЭНИЙ ЖАГСААЛТ ТАТАХ
// ************************************************************
async function fetchNewsList() {
    const { data, error } = await supabase
        .from('news')
        .select('id, title, created_at, active, slug')
        .order('created_at', { ascending: false })
        .limit(29); // Зөвхөн 29 мэдээг татаж харуулна

    const container = document.getElementById('newsListContainer');
    container.innerHTML = '';

    if (error) {
        container.innerHTML = `<p class="error">Мэдээ татахад алдаа гарлаа: ${error.message}</p>`;
        return;
    }

    if (data.length === 0) {
        container.innerHTML = '<p>Одоогоор нийтлэгдсэн мэдээ алга байна.</p>';
        return;
    }

    data.forEach(news => {
        const item = document.createElement('div');
        item.className = 'news-list-item';
        item.innerHTML = `
            <span class="news-title" style="color: ${news.active ? '#333' : '#999'}">${news.title}</span>
            <span style="font-size: 12px; color: #666;">${new Date(news.created_at).toLocaleDateString()}</span>
            <div class="news-actions">
                <button class="edit-btn" onclick="editNews('${news.slug}')">Засах</button>
                <button class="delete-btn" onclick="deleteNews(${news.id})">Устгах</button>
            </div>
        `;
        container.appendChild(item);
    });
}

// ************************************************************
// 2. МЭДЭЭГ ЗАСАХ ТАЛБАРТ УТГА ОРУУЛАХ
// ************************************************************
window.editNews = async function(slug) {
    const { data, error } = await supabase
        .from('news')
        .select('*')
        .eq('slug', slug)
        .single();

    if (error) {
        showMessage(`Мэдээ татахад алдаа гарлаа: ${error.message}`, 'error');
        return;
    }

    // Талбаруудад утгыг оруулах
    document.getElementById('newsId').value = data.id;
    document.getElementById('newsFormTitle').innerText = 'Мэдээ засах';
    document.getElementById('newsTitle').value = data.title;
    document.getElementById('newsSlug').value = data.slug;
    document.getElementById('newsCategory').value = data.category || 'Улс төр'; 
    document.getElementById('newsImage').value = data.image || '';
    document.getElementById('newsFeatured').checked = data.featured || false;
    document.getElementById('newsActive').checked = data.active;
    
    // TinyMCE-ийн textarea-д HTML утгыг оруулах
    const contentElement = document.getElementById('newsContent');
    contentElement.value = data.content; 
    
    // TinyMCE Editor-т утгыг ачаалах
    // Энэ нь TinyMCE-ийг "reset" хийж, шинэ утгыг зөв ачаална.
    if (tinymce.get('newsContent')) {
        tinymce.get('newsContent').setContent(data.content || '');
    }

    // Хадгалах товчийг 'Засах' горимд шилжүүлэх
    document.getElementById('saveNewsBtn').onclick = () => saveNews(false);
    document.getElementById('saveNewsBtn').innerText = 'Өөрчлөлт хадгалах';
    
    // "Мэдээ нэмэх" таб руу шилжих
    openTab('createNews');
};

// ************************************************************
// 3. МЭДЭЭГ ХАДГАЛАХ (Шинэчлэх/Нэмэх)
// ************************************************************
window.saveNews = async function(isNew) {
    
    // ✅ 1. TINYMCE-ээс Утгыг Авах
    const content = tinymce.get('newsContent').getContent();
    
    // 2. Бусад талбаруудаас утгыг авах
    const newsId = document.getElementById('newsId').value;
    const title = document.getElementById('newsTitle').value;
    const slug = document.getElementById('newsSlug').value;
    const category = document.getElementById('newsCategory').value;
    const image = document.getElementById('newsImage').value;
    const featured = document.getElementById('newsFeatured').checked;
    const active = document.getElementById('newsActive').checked;
    
    if (!title || !slug || !content) {
        showMessage('Гарчиг, Slug, Агуулгын талбарыг бөглөнө үү.', 'error');
        return;
    }

    const newsData = {
        title: title,
        slug: slug,
        category: category,
        image: image || null,
        content: content, // ✅ TINYMCE-ЭЭС АВСАН HTML КОНТЕНТ
        featured: featured,
        active: active,
        // created_at, author_id-г Supabase-д defaults-аар оруулах боломжтой
    };

    let response;
    
    if (isNew) {
        // Шинэ мэдээ оруулах
        response = await supabase.from('news').insert([newsData]);
    } else {
        // Одоо байгаа мэдээг шинэчлэх
        response = await supabase.from('news').update(newsData).eq('id', newsId);
    }
    
    if (response.error) {
        showMessage(`Хадгалахад алдаа гарлаа: ${response.error.message}`, 'error');
    } else {
        showMessage(isNew ? 'Мэдээ амжилттай нэмэгдлээ!' : 'Мэдээ амжилттай шинэчлэгдлээ!', 'success');
        resetForm();
        fetchNewsList();
        openTab('listNews');
    }
};

// ************************************************************
// 4. МЭДЭЭГ УСТГАХ
// ************************************************************
window.deleteNews = async function(id) {
    if (!confirm('Та энэ мэдээг устгахдаа итгэлтэй байна уу?')) return;

    const { error } = await supabase
        .from('news')
        .delete()
        .eq('id', id);

    if (error) {
        showMessage(`Устгахад алдаа гарлаа: ${error.message}`, 'error');
    } else {
        showMessage('Мэдээ амжилттай устгагдлаа.', 'success');
        fetchNewsList();
    }
};

// ************************************************************
// 5. ТУСЛАХ ФУНКЦҮҮД
// ************************************************************
window.openTab = function(tabName, elm) {
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(content => content.classList.remove('active'));
    
    const sidebarButtons = document.querySelectorAll('.sidebar button');
    sidebarButtons.forEach(button => button.classList.remove('active'));

    document.getElementById(tabName).classList.add('active');
    
    if (elm) {
        elm.classList.add('active');
    } else {
        // Хэрэв товчлуургүйгээр буцвал жагсаалтын тавцангийн товчийг идэвхжүүлнэ
        document.getElementById('tabListNews').classList.add('active');
    }
    
    if (tabName === 'createNews') {
        // 'Нэмэх' таб руу шилжихэд, хэрэв засах горим биш бол формыг цэвэрлэнэ
        if (document.getElementById('newsFormTitle').innerText !== 'Мэдээ засах') {
            resetForm();
        }
    } else if (tabName === 'listNews') {
        // Жагсаалтын таб руу шилжихэд формыг цэвэрлэж, үндсэн товчийг сэргээнэ
        resetForm();
    }
    
    // Мессежийг нуух
    document.getElementById('responseMessage').style.display = 'none';
};

function resetForm() {
    document.getElementById('newsId').value = '';
    document.getElementById('newsFormTitle').innerText = 'Мэдээ нэмэх';
    document.getElementById('newsTitle').value = '';
    document.getElementById('newsSlug').value = '';
    document.getElementById('newsImage').value = '';
    document.getElementById('newsCategory').value = 'Улс төр'; 
    document.getElementById('newsFeatured').checked = false;
    document.getElementById('newsActive').checked = true;
    
    // TinyMCE-ийн агуулгыг цэвэрлэх
    if (tinymce.get('newsContent')) {
        tinymce.get('newsContent').setContent('');
    }
    // saveNews товчийг анхны байдалд оруулах
    document.getElementById('saveNewsBtn').onclick = () => saveNews(true);
    document.getElementById('saveNewsBtn').innerText = 'Хадгалах';
}

function showMessage(message, type) {
    const msgEl = document.getElementById('responseMessage');
    msgEl.innerText = message;
    msgEl.className = type === 'success' ? 'success' : 'error';
    msgEl.style.display = 'block';
    // 5 секундын дараа нуух
    setTimeout(() => {
        msgEl.style.display = 'none';
    }, 5000);
}

window.logout = function() {
    // Хэрэглэгч гарах үед хийх үйлдлүүд (жишээ нь, LocalStorage цэвэрлэх)
    alert('Системээс гарах үйлдлийг хийх JS логик оруулаарай.');
};

// Хуудас ачаалагдахад жагсаалтыг татах
window.onload = function() {
    fetchNewsList();
    // TinyMCE-ийн init нь өөрөө ачаалагдана
};

</script>
</body>
</html>
