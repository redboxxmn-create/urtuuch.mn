<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ Панел</title>

    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        body { font-family: 'Ubuntu', sans-serif; background: #f4f6f8; margin: 0; padding: 0; }
        header { 
            background: #3d85c6; 
            color: #fff; 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .container { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        input, select { width: 100%; padding: 8px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { padding: 8px 15px; margin-right: 5px; border: none; border-radius: 8px; cursor: pointer; background: #6fa8dc; color: #fff; transition: background 0.3s; }
        button:hover { background: #3d85c6; }
        
        #logoutButton {
            background: #ff5252;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: #fff;
            transition: background 0.3s;
        }
        #logoutButton:hover {
            background: #e04040;
        }
        
        .list-item { padding: 8px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        #editor { height: 150px; }
        .group-title { font-weight: bold; margin-top: 20px; color: #3d85c6; border-bottom: 2px solid #3d85c6; padding-bottom: 5px; }
        .search-input { margin-bottom: 10px; padding: 8px; width: 100%; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;}
        .checkbox-group { display: flex; gap: 20px; margin: 10px 0; }
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .card { grid-column: span 1 !important; }
        }
    </style>
</head>
<body>

<header>
    <h1>Админ Панел</h1>
    <button id="logoutButton" onclick="handleLogout()" style="display: none;">Гарах</button>
</header>

<div id="loginFormContainer">
    <div class="card" style="max-width: 400px; margin: 50px auto; text-align: center;">
        <h2>Админ Нэвтрэх</h2>
        <input id="loginEmail" type="email" placeholder="И-мэйл" required>
        <input id="loginPassword" type="password" placeholder="Нууц үг" required>
        <button onclick="handleLogin()">Нэвтрэх</button>
        <p id="loginError" style="color: red; margin-top: 10px;"></p>
    </div>
</div>

<div class="container" id="adminContent" style="display: none;">

    <div class="card">
        <h2>Мэдээ нэмэх / засах</h2>
        <input type="hidden" id="editIndex">
        <input id="newsTitle" placeholder="Гарчиг">
        <select id="newsCategory">
            <option value="">Ангилал</option>
            <option>Улс төр</option>
            <option>Эдийн засаг</option>
            <option>Соёл урлаг</option>
            <option>Медиа</option>
            <option>Дэлхий дахинд</option>
            <option>Ярилцлага</option>
        </select> 
        <input id="newsImage" placeholder="Зураг URL">
        <div id="editor"></div>
        <select id="newsAuthor"></select>
        
        <div class="checkbox-group">
            <label><input type="checkbox" id="newsFeatured"> Онцлох</label>
            <label><input type="checkbox" id="newsActive"> Идэвхтэй / Нийтлэх</label> 
        </div>
        
        <button onclick="saveNews()">Хадгалах</button>
        <button onclick="clearNewsForm()">Цэвэрлэх</button>
    </div>

    <div class="card">
        <h2>Нийтлэлч</h2>
        <input type="hidden" id="editAuthorIndex">
        <input id="authorName" placeholder="Нэр">
        <input id="authorTitle" placeholder="Албан тушаал">
        <input id="authorImage" placeholder="Зураг">
        <button onclick="saveAuthor()">Хадгалах</button>
        <button onclick="clearAuthorForm()">Цэвэрлэх</button>
    </div>

    <div class="card" style="grid-column: span 2;">
        <h2>Системийн Хэрэглэгчид (Supabase Auth)</h2>
        <button onclick="openAddUserModal()">+ Хэрэглэгч Нэмэх</button>
        <div id="authUsersList"></div>
    </div>
    
    <div class="card" style="grid-column: span 2;">
        <input type="text" id="searchInput" class="search-input" placeholder="Мэдээ хайх...">
    </div>

    <div class="card" style="grid-column: span 2;">
        <h2>Мэдээ</h2>
        <div id="newsList"></div>
    </div>

    <div class="card" style="grid-column: span 2;">
        <h2>Нийтлэлчид</h2>
        <div id="authorList"></div>
    </div>

</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 

<script>
// DOM элементүүд
const newsTitle = document.getElementById("newsTitle");
const newsCategory = document.getElementById("newsCategory");
const newsImage = document.getElementById("newsImage");
const newsAuthor = document.getElementById("newsAuthor");
const newsFeatured = document.getElementById("newsFeatured");
const newsActive = document.getElementById("newsActive"); 
const newsList = document.getElementById("newsList");
const editIndex = document.getElementById("editIndex");

const authorName = document.getElementById("authorName");
const authorTitle = document.getElementById("authorTitle");
const authorImage = document.getElementById("authorImage");
const editAuthorIndex = document.getElementById("editAuthorIndex");
const authorList = document.getElementById("authorList");

const searchInput = document.getElementById("searchInput");

// Нэвтрэх хэсгийн DOM элементүүд
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const loginError = document.getElementById("loginError");
const loginFormContainer = document.getElementById("loginFormContainer");
const adminContent = document.getElementById("adminContent");
const logoutButton = document.getElementById("logoutButton");
const authUsersList = document.getElementById("authUsersList");


// Supabase client 
// ЭНД ТАНЫ SUPABASE ТӨСЛИЙН МЭДЭЭЛЭЛ ОРНО
const supabaseUrl = "https://wpotnvekaoosdkvmhqgo.supabase.co"; 
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indwb3RudmVrYW9vc2Rrdm1ocWdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTU3NjQsImV4cCI6MjA4MDU5MTc2NH0.YIpy_IA9nNseYUJB3Y-adxgv9btgAt5IKP5FJpafNC0";

const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey); 

// ===================================================
// Quill-д Text Alignment-ийн Загваруудыг Нэмэх
// ===================================================
const AlignStyle = Quill.import('attributors/style/align');
// 'right', 'center', 'justify' (тэгш) гэсэн тэгшлэлтүүдийг зөвшөөрнө
AlignStyle.whitelist = ['right', 'center', 'justify']; 
Quill.register(AlignStyle, true);


// Quill editor (Тэгшлэх товчлууруудтай)
const quill = new Quill("#editor", { 
    theme: "snow",
    modules: {
        toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'], 
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            // Текст тэгшлэх товчлуурууд
            [{ 'align': [] }], 
            ['link', 'image'],
            ['clean']
        ]
    }
});


// ---------------------------------------------------
// AUTH FUNCTIONS (Нэвтрэх / Гарах)
// ---------------------------------------------------

async function checkAuthAndRenderUI() {
    const { data: { user } } = await supabaseClient.auth.getUser();

    if (user) {
        // Нэвтэрсэн
        loginFormContainer.style.display = 'none';
        adminContent.style.display = 'grid';
        logoutButton.style.display = 'block';
        initializeAdminPanel(); 
    } else {
        // Нэвтрээгүй
        loginFormContainer.style.display = 'block';
        adminContent.style.display = 'none';
        logoutButton.style.display = 'none';
    }
}

async function handleLogin() {
    loginError.textContent = '';
    const email = loginEmail.value.trim();
    const password = loginPassword.value.trim();

    if (!email || !password) {
        loginError.textContent = "И-мэйл болон нууц үг заавал бөглөнө.";
        return;
    }

    const { error } = await supabaseClient.auth.signInWithPassword({
        email: email,
        password: password,
    });

    if (error) {
        console.error("Login error:", error);
        loginError.textContent = "Нэвтрэх нэр эсвэл нууц үг буруу байна. (" + error.message + ")";
    } else {
        loginEmail.value = '';
        loginPassword.value = '';
        await checkAuthAndRenderUI();
    }
}

async function handleLogout() {
    if (confirm("Системээс гарах уу?")) {
        await supabaseClient.auth.signOut();
        await checkAuthAndRenderUI();
    }
}


// ---------------------------------------------------
// AUTH USERS (Зөвхөн Authors-ийг Auth Users-ийн оронд харуулъя)
// ---------------------------------------------------

async function displayAuthUsers() {
    // Client side-аас Supabase-ын бүх Auth хэрэглэгчдийг татах нь RLS-ээр хязгаарлагддаг.
    // Энэ хэсэгт бид зөвхөн "Авторууд"-ыг харуулж, UI-г бэлдлээ.
    const list = await fetchAuthors(); 
    authUsersList.innerHTML = "";

    if (!list.length) { 
        authUsersList.innerHTML = "<p>Системд хэрэглэгч/нийтлэлч байхгүй. Дээрх товчоор нэмнэ үү.</p>"; 
        return; 
    }
    
    authUsersList.innerHTML = `<div style="margin-top: 10px;">` + list.map(a => `
        <div class="list-item">
            <span>${a.name} (ID: ${a.id})</span>
            <span>
                <button onclick="alert('Энэхүү функц нь зөвхөн Auth ID-аар ажиллах ёстой.')">Удирдах</button>
            </span>
        </div>
    `).join("") + `</div>`;
}


async function openAddUserModal() {
    const email = prompt("Шинэ хэрэглэгчийн и-мэйл:");
    if (!email) return;
    const password = prompt("Шинэ хэрэглэгчийн нууц үг:");
    if (!password) return;

    // Supabase Auth-д бүртгэнэ
    const { error } = await supabaseClient.auth.signUp({
        email: email,
        password: password,
        options: {
            // Энэ нь Confirm Email идэвхтэй байсан ч нэвтрэхийг зөвшөөрөхөд тусалдаг
            emailRedirectTo: window.location.origin
        }
    });

    if (error) {
        alert("Хэрэглэгч нэмэхэд алдаа гарлаа: " + error.message);
    } else {
        alert(`Хэрэглэгч ${email} амжилттай нэмэгдлээ. Хэрэв Email Confirmation идэвхтэй бол, и-мэйлээ шалгана уу.`);
        
        // Хэрэв та Auth-д нэмэгдсэн хэрэглэгчийг Authors хүснэгтэд автоматаар нэмэхийг хүсвэл:
        // await supabaseClient.from("authors").insert({ name: email, title: "Системийн хэрэглэгч", image: null }); 
        
        displayAuthUsers();
    }
}


// ---------------------------------------------------
// SLUG GENERATION FUNCTION
// ---------------------------------------------------

function cyrillicToLatin(text) {
    const cyrToLat = {
        'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'ye', 'ё': 'yo', 'ж': 'j', 'з': 'z', 'и': 'i', 'й': 'i',
        'к': 'k', 'л': 'l', 'м': 'm', 'н': 'n', 'о': 'o', 'ө': 'o', 'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u',
        'ү': 'u', 'ф': 'f', 'х': 'h', 'ц': 'ts', 'ч': 'ch', 'ш': 'sh', 'щ': 'sh', 'ъ': '', 'ы': 'i', 'ь': '',
        'э': 'e', 'ю': 'yu', 'я': 'ya', 'А': 'A', 'Б': 'B', 'В': 'V', 'Г': 'G', 'Д': 'D', 'Е': 'Ye', 'Ё': 'Yo',
        'Ж': 'J', 'З': 'Z', 'И': 'I', 'Й': 'I', 'К': 'K', 'Л': 'L', 'М': 'M', 'Н': 'N', 'О': 'O', 'Ө': 'O',
        'П': 'P', 'Р': 'R', 'С': 'S', 'Т': 'T', 'У': 'U', 'Ү': 'U', 'Ф': 'F', 'Х': 'H', 'Ц': 'Ts', 'Ч': 'Ch',
        'Ш': 'Sh', 'Щ': 'Sh', 'Ъ': '', 'Ы': 'I', 'Ь': '', 'Э': 'E', 'Ю': 'Yu', 'Я': 'Ya'
    };

    let result = '';
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        result += cyrToLat[char] || char;
    }
    return result;
}

function generateSlug(title) {
    let slug = cyrillicToLatin(title);
    slug = slug.toLowerCase();
    slug = slug.replace(/\s+/g, '-');
    slug = slug.replace(/[^\w-]+/g, '');
    slug = slug.replace(/--+/g, '-');
    slug = slug.replace(/^-+|-+$/g, '');
    
    return slug;
}


// ---------------------------------------------------
// AUTHORS (Үндсэн логикууд)
// ---------------------------------------------------
async function fetchAuthors() {
    const { data } = await supabaseClient.from("authors").select("*").order("id");
    return data || [];
}

async function populateAuthorSelect() {
    const list = await fetchAuthors();
    newsAuthor.innerHTML = list.length
        ? list.map(a => `<option value="${a.id}">${a.name}</option>`).join("")
        : `<option disabled>Нийтлэлч байхгүй</option>`;
}

async function displayAuthors() {
    const list = await fetchAuthors();
    authorList.innerHTML = list.length
        ? list.map(a => `
            <div class="list-item">
                <span>${a.name} (${a.title})</span>
                <span>
                    <button onclick="editAuthor(${a.id})">Засах</button>
                    <button onclick="removeAuthor(${a.id})">Устгах</button>
                </span>
            </div>
        `).join("")
        : "Нийтлэлч байхгүй";
}

async function saveAuthor() {
    const data = {
        name: authorName.value.trim(),
        title: authorTitle.value.trim(),
        image: authorImage.value.trim()
    };
    if (!data.name) return alert("Нэр заавал бөглөнө");

    if (editAuthorIndex.value === "")
        await supabaseClient.from("authors").insert(data);
    else
        await supabaseClient.from("authors").update(data).eq("id", editAuthorIndex.value);

    clearAuthorForm();
    populateAuthorSelect();
    displayAuthors();
    displayAuthUsers(); // Auth User-ийн жагсаалтыг шинэчлэх
}

async function editAuthor(id) {
    const { data } = await supabaseClient.from("authors").select("*").eq("id", id).single();
    editAuthorIndex.value = data.id;
    authorName.value = data.name;
    authorTitle.value = data.title;
    authorImage.value = data.image;
}

async function removeAuthor(id) {
    if (confirm("Устгах уу?")) {
        await supabaseClient.from("authors").delete().eq("id", id);
        populateAuthorSelect();
        displayAuthors();
        displayAuthUsers(); // Auth User-ийн жагсаалтыг шинэчлэх
    }
}

function clearAuthorForm() {
    editAuthorIndex.value = "";
    authorName.value = "";
    authorTitle.value = "";
    authorImage.value = "";
}

// ---------------------------------------------------
// NEWS (Үндсэн логикууд)
// ---------------------------------------------------
async function fetchNews() {
    const { data } = await supabaseClient.from("news").select("*").order("created_at", { ascending: false });
    return data || [];
}

async function displayNews(filter = "") {
    const news = await fetchNews();
    const authors = await fetchAuthors();
    newsList.innerHTML = "";

    let filteredNews = news;
    if (filter) {
        filteredNews = news.filter(n => n.title.toLowerCase().includes(filter.toLowerCase()));
    }

    if (!filteredNews.length) { newsList.innerHTML = "Мэдээ байхгүй"; return; }

    const grouped = {};
    filteredNews.forEach(n => {
        const day = n.created_at ? n.created_at.split("T")[0] : "Огноо байхгүй";
        if (!grouped[day]) grouped[day] = [];
        grouped[day].push(n);
    });

    for (const d in grouped) {
        newsList.innerHTML += `<div class="group-title">${d}</div>`;
        grouped[d].forEach(n => {
            const aut = authors.find(a => a.id == n.author_id)?.name || "Тодорхойгүй";
            const activeStatus = n.active ? " (Идэвхтэй)" : " (Ноорог)"; 
            
            const slugStatus = !n.slug || n.slug.length < 3 ? " ⚠️ SLUG АЛГА/БУРУУ" : "";

            newsList.innerHTML += `
            <div class="list-item">
                <span>${n.title} | ${n.category} | ${aut} ${n.featured ? " | Онцлох" : ""} ${activeStatus}${slugStatus}</span>
                <span>
                    <button onclick="editNews(${n.id})">Засах</button>
                    <button onclick="removeNews(${n.id})">Устгах</button>
                </span>
            </div>`;
        });
    }
}

async function saveNews() {
    const html = quill.root.innerHTML.trim();
    const titleValue = newsTitle.value.trim();
    
    if (!titleValue) return alert("Гарчиг заавал бөглөнө");
    
    const data = {
        title: titleValue,
        slug: generateSlug(titleValue), 
        category: newsCategory.value || null,
        image: newsImage.value.trim() || null,
        description: html || null,
        author_id: newsAuthor.value ? Number(newsAuthor.value) : null,
        featured: newsFeatured.checked,
        active: newsActive.checked 
    };
    
    if (!data.author_id) return alert("Нийтлэлч сонгоно уу");

    let result;
    if (editIndex.value === "") {
        result = await supabaseClient.from("news").insert(data);
    } else {
        result = await supabaseClient.from("news").update(data).eq("id", editIndex.value);
    }
    
    if (result.error) {
        console.error("News save error:", result.error);
        alert(`Мэдээ хадгалахад алдаа гарлаа: ${result.error.message}. Slug давхардсан эсэхийг шалгана уу.`);
    } else {
        alert("Мэдээ амжилттай хадгалагдлаа.");
    }

    clearNewsForm();
    displayNews(searchInput.value);
}

async function editNews(id) {
    const { data } = await supabaseClient.from("news").select("*").eq("id", id).single();
    editIndex.value = data.id;
    newsTitle.value = data.title;
    newsCategory.value = data.category;
    newsImage.value = data.image;
    newsAuthor.value = data.author_id;
    newsFeatured.checked = data.featured;
    newsActive.checked = data.active; 
    quill.root.innerHTML = data.description;
}

async function removeNews(id) {
    if (confirm("Устгах уу?")) {
        await supabaseClient.from("news").delete().eq("id", id);
        displayNews(searchInput.value);
    }
}

function clearNewsForm() {
    editIndex.value = "";
    newsTitle.value = "";
    newsCategory.value = "";
    newsImage.value = "";
    newsFeatured.checked = false;
    newsActive.checked = false; 
    quill.setText("");
}

// Search listener
searchInput.addEventListener("input", () => {
    displayNews(searchInput.value);
});

// Global scope-д функцуудыг гаргах (onclick үйлдэл ажиллахын тулд)
window.saveNews = saveNews;
window.clearNewsForm = clearNewsForm;
window.editNews = editNews;
window.removeNews = removeNews;
window.saveAuthor = saveAuthor;
window.clearAuthorForm = clearAuthorForm;
window.editAuthor = editAuthor;
window.removeAuthor = removeAuthor;
window.handleLogin = handleLogin;
window.handleLogout = handleLogout;
window.openAddUserModal = openAddUserModal;


// INIT
function initializeAdminPanel() {
    populateAuthorSelect();
    displayAuthors();
    displayNews();
    displayAuthUsers();
}

// Хуудсыг эхлүүлэх: Эхлээд Auth-г шалгана
checkAuthAndRenderUI();
</script>
</body>
</html>
