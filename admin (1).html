<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª</title>

    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        body { font-family: 'Ubuntu', sans-serif; background: #f4f6f8; margin: 0; padding: 0; }
        header { 
            background: #3d85c6; 
            color: #fff; 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .container { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        input, select { width: 100%; padding: 8px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { padding: 8px 15px; margin-right: 5px; border: none; border-radius: 8px; cursor: pointer; background: #6fa8dc; color: #fff; transition: background 0.3s; }
        button:hover { background: #3d85c6; }
        
        #logoutButton {
            background: #ff5252;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: #fff;
            transition: background 0.3s;
        }
        #logoutButton:hover {
            background: #e04040;
        }
        
        .list-item { padding: 8px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        #editor { height: 150px; }
        .group-title { font-weight: bold; margin-top: 20px; color: #3d85c6; border-bottom: 2px solid #3d85c6; padding-bottom: 5px; }
        .search-input { margin-bottom: 10px; padding: 8px; width: 100%; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;}
        .checkbox-group { display: flex; gap: 20px; margin: 10px 0; }
        /* –ó—É—Ä–∞–≥ –æ—Ä—É—É–ª–∞—Ö —Ç–∞–ª–±–∞—Ä—ã–Ω —Å—Ç–∏–ª–∏–π–≥ Mobile-–¥ –∑”©–≤ —Ö–∞—Ä—É—É–ª–∞—Ö—ã–Ω —Ç—É–ª–¥ –Ω—ç–º—ç–≤ */
        #imageUpload { padding: 4px; height: auto; }

        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .card { grid-column: span 1 !important; }
        }
    </style>
</head>
<body>

<header>
    <h1>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª</h1>
    <button id="logoutButton" onclick="handleLogout()" style="display: none;">–ì–∞—Ä–∞—Ö</button>
</header>

<div id="loginFormContainer">
    <div class="card" style="max-width: 400px; margin: 50px auto; text-align: center;">
        <h2>–ê–¥–º–∏–Ω –ù—ç–≤—Ç—Ä—ç—Ö</h2>
        <input id="loginEmail" type="email" placeholder="–ò-–º—ç–π–ª" required>
        <input id="loginPassword" type="password" placeholder="–ù—É—É—Ü “Ø–≥" required>
        <button onclick="handleLogin()">–ù—ç–≤—Ç—Ä—ç—Ö</button>
        <p id="loginError" style="color: red; margin-top: 10px;"></p>
    </div>
</div>

<div class="container" id="adminContent" style="display: none;">

    <div class="card">
        <h2>–ú—ç–¥—ç—ç –Ω—ç–º—ç—Ö / –∑–∞—Å–∞—Ö</h2>
        <input type="hidden" id="editIndex">
        <input id="newsTitle" placeholder="–ì–∞—Ä—á–∏–≥">
        <select id="newsCategory">
            <option value="">–ê–Ω–≥–∏–ª–∞–ª</option>
            <option>–£–ª—Å —Ç”©—Ä</option>
            <option>–≠–¥–∏–π–Ω –∑–∞—Å–∞–≥</option>
            <option>–°–æ—ë–ª —É—Ä–ª–∞–≥</option>
            <option>–ú–µ–¥–∏–∞</option>
            <option>–î—ç–ª—Ö–∏–π –¥–∞—Ö–∏–Ω–¥</option>
            <option>–Ø—Ä–∏–ª—Ü–ª–∞–≥–∞</option>
        </select>
        
        <div style="margin: 10px 0;">
            <label for="imageUpload">–ó—É—Ä–∞–≥ —Å–æ–Ω–≥–æ—Ö:</label>
            <input type="file" id="imageUpload" accept="image/*" style="padding: 4px; height: auto;">
            <button id="uploadButton" type="button" style="background: #2ecc71;">–ó—É—Ä–∞–≥ –æ—Ä—É—É–ª–∞—Ö</button>
            <div id="uploadStatus" style="font-size: 12px; margin-top: 5px;"></div>
            <img id="previewImage" src="" style="max-width: 150px; height: auto; margin-top: 10px; border-radius: 8px; display: none;">
            
            <input type="hidden" id="newsImage" value=""> 
            
            <input type="text" id="newsImageURLManual" placeholder="–≠—Å–≤—ç–ª –ó—É—Ä–∞–≥ URL-–∏–π–≥ –≥–∞—Ä–∞–∞—Ä –æ—Ä—É—É–ª–Ω–∞ —É—É" style="margin-top: 10px;">
        </div>
        <select id="newsCardType">
            <option value="normal">–≠–Ω–≥–∏–π–Ω –º—ç–¥—ç—ç (Normal)</option>
            <option value="sub_featured">–î—ç–¥ –æ–Ω—Ü–ª–æ—Ö (Sub-Featured)</option>
            <option value="featured_large">–û–Ω—Ü–ª–æ—Ö –¢–æ–º –ö–∞—Ä—Ç (Featured Large)</option>
        </select>
        <div id="editor"></div>
        <select id="newsAuthor"></select>
        
        <div class="checkbox-group">
            <label><input type="checkbox" id="newsFeatured"> –û–Ω—Ü–ª–æ—Ö</label>
            <label><input type="checkbox" id="newsActive"> –ò–¥—ç–≤—Ö—Ç—ç–π / –ù–∏–π—Ç–ª—ç—Ö</label> 
        </div>
        
        <button onclick="saveNews()">–•–∞–¥–≥–∞–ª–∞—Ö</button>
        <button onclick="clearNewsForm()">–¶—ç–≤—ç—Ä–ª—ç—Ö</button>
    </div>

    <div class="card">
        <h2>–ù–∏–π—Ç–ª—ç–ª—á</h2>
        <input type="hidden" id="editAuthorIndex">
        <input id="authorName" placeholder="–ù—ç—Ä">
        <input id="authorTitle" placeholder="–ê–ª–±–∞–Ω —Ç—É—à–∞–∞–ª">
        <input id="authorImage" placeholder="–ó—É—Ä–∞–≥">
        <button onclick="saveAuthor()">–•–∞–¥–≥–∞–ª–∞—Ö</button>
        <button onclick="clearAuthorForm()">–¶—ç–≤—ç—Ä–ª—ç—Ö</button>
    </div>

    <div class="card" style="grid-column: span 2;">
        <h2>–°–∏—Å—Ç–µ–º–∏–π–Ω –•—ç—Ä—ç–≥–ª—ç–≥—á–∏–¥ (Supabase Auth)</h2>
        <button onclick="openAddUserModal()">+ –•—ç—Ä—ç–≥–ª—ç–≥—á –ù—ç–º—ç—Ö</button>
        <div id="authUsersList"></div>
    </div>
    
    <div class="card" style="grid-column: span 2;">
        <input type="text" id="searchInput" class="search-input" placeholder="–ú—ç–¥—ç—ç —Ö–∞–π—Ö...">
    </div>

    <div class="card" style="grid-column: span 2;">
        <h2>–ú—ç–¥—ç—ç</h2>
        <div id="newsList"></div>
    </div>

    <div class="card" style="grid-column: span 2;">
        <h2>–ù–∏–π—Ç–ª—ç–ª—á–∏–¥</h2>
        <div id="authorList"></div>
    </div>

</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 

<script>
// DOM —ç–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥
const newsTitle = document.getElementById("newsTitle");
const newsCategory = document.getElementById("newsCategory");
const newsImage = document.getElementById("newsImage"); // üí° –≠–Ω—ç –æ–¥–æ–æ hidden —Ç–∞–ª–±–∞—Ä –±–æ–ª—Å–æ–Ω
const newsCardType = document.getElementById("newsCardType"); 
const newsAuthor = document.getElementById("newsAuthor");
const newsFeatured = document.getElementById("newsFeatured");
const newsActive = document.getElementById("newsActive"); 
const newsList = document.getElementById("newsList");
const editIndex = document.getElementById("editIndex");

const authorName = document.getElementById("authorName");
const authorTitle = document.getElementById("authorTitle");
const authorImage = document.getElementById("authorImage");
const editAuthorIndex = document.getElementById("editAuthorIndex");
const authorList = document.getElementById("authorList");

const searchInput = document.getElementById("searchInput");

// –ù—ç–≤—Ç—Ä—ç—Ö —Ö—ç—Å–≥–∏–π–Ω DOM —ç–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const loginError = document.getElementById("loginError");
const loginFormContainer = document.getElementById("loginFormContainer");
const adminContent = document.getElementById("adminContent");
const logoutButton = document.getElementById("logoutButton");
const authUsersList = document.getElementById("authUsersList");

// üí° –ó—É—Ä–∞–≥ Upload —Ö–∏–π—Ö DOM —ç–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥
const imageUploadInput = document.getElementById('imageUpload');
const uploadButton = document.getElementById('uploadButton');
const uploadStatus = document.getElementById('uploadStatus');
const previewImage = document.getElementById('previewImage');
const newsImageURLManual = document.getElementById('newsImageURLManual');

// Supabase client 
// –≠–ù–î –¢–ê–ù–´ SUPABASE –¢”®–°–õ–ò–ô–ù –ú–≠–î–≠–≠–õ–≠–õ –û–†–ù–û
const supabaseUrl = "https://wpotnvekaoosdkvmhqgo.supabase.co"; 
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indwb3RudmVrYW9vc2Rrdm1ocWdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTU3NjQsImV4cCI6MjA4MDU5MTc2NH0.YIpy_IA9nNseYUJB3Y-adxgv9btgAt5IKP5FJpafNC0";

const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey); 

// ===================================================
// Quill Editor Setup
// ===================================================
const AlignStyle = Quill.import('attributors/style/align');
AlignStyle.whitelist = ['right', 'center', 'justify']; 
Quill.register(AlignStyle, true);

const quill = new Quill("#editor", { 
    theme: "snow",
    modules: {
        toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'], 
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'align': [] }], 
            ['link', 'image'],
            ['clean']
        ]
    }
});

// ---------------------------------------------------
// IMAGE UPLOAD (Supabase Storage) - üí° –ì–û–õ –§–£–ù–ö–¶
// ---------------------------------------------------

const BUCKET_NAME = 'news_images'; // Supabase Storage –¥—ç—ç—Ä—Ö Bucket-–∏–π–Ω –Ω—ç—Ä

uploadButton.addEventListener('click', async () => {
    const file = imageUploadInput.files[0];
    if (!file) {
        uploadStatus.textContent = '–ó—É—Ä–∞–≥ —Å–æ–Ω–≥–æ–Ω–æ —É—É.';
        uploadStatus.style.color = 'red';
        return;
    }

    uploadStatus.textContent = '–ó—É—Ä–∞–≥ –æ—Ä—É—É–ª–∂ –±–∞–π–Ω–∞... (–•“Ø–ª—ç—ç–≥—ç—ç—Ä—ç–π)';
    uploadStatus.style.color = 'orange';
    newsImage.value = ''; // –ù—É—É—Ü URL —Ç–∞–ª–±–∞—Ä—ã–≥ —Ü—ç–≤—ç—Ä–ª—ç—Ö
    newsImageURLManual.value = ''; // –ì–∞—Ä–∞–∞—Ä –æ—Ä—É—É–ª—Å–∞–Ω —Ç–∞–ª–±–∞—Ä—ã–≥ —Ü—ç–≤—ç—Ä–ª—ç—Ö

    // –§–∞–π–ª—ã–Ω –Ω—ç—Ä: Unique ID + ”®—Ä–≥”©—Ç–≥”©–ª
    const fileExtension = file.name.split('.').pop();
    const filePath = `news/${Date.now()}_${Math.random().toString(36).substring(2, 9)}.${fileExtension}`;

    try {
        // 1. –§–∞–π–ª—ã–≥ Supabase Storage —Ä—É—É –æ—Ä—É—É–ª–∞—Ö
        const { error: uploadError } = await supabaseClient.storage
            .from(BUCKET_NAME)
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
            });

        if (uploadError) throw uploadError;

        // 2. –û—Ä—É—É–ª—Å–∞–Ω –∑—É—Ä–≥–∏–π–Ω –Ω–∏–π—Ç–∏–π–Ω URL-–∏–π–≥ –∞–≤–∞—Ö
        const { data: publicURLData } = supabaseClient.storage
            .from(BUCKET_NAME)
            .getPublicUrl(filePath);

        const imageUrl = publicURLData.publicUrl;

        // 3. “Æ—Ä –¥“Ø–Ω–≥ —Ö–∞–¥–≥–∞–ª–∂, UI-–¥ —Ö–∞—Ä—É—É–ª–∞—Ö
        newsImage.value = imageUrl; 
        previewImage.src = imageUrl;
        previewImage.style.display = 'block';

        uploadStatus.textContent = '–ó—É—Ä–∞–≥ –∞–º–∂–∏–ª—Ç—Ç–∞–π –æ—Ä—É—É–ª–∞–≤!';
        uploadStatus.style.color = 'green';
        
    } catch (error) {
        console.error("–ó—É—Ä–∞–≥ –æ—Ä—É—É–ª–∞—Ö –∞–ª–¥–∞–∞:", error);
        uploadStatus.textContent = `–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ${error.message}. Storage-–∏–π–Ω —Ç–æ—Ö–∏—Ä–≥–æ–æ–≥ —à–∞–ª–≥–∞–Ω–∞ —É—É.`;
        uploadStatus.style.color = 'red';
    }
});

// –ì–∞—Ä–∞–∞—Ä URL –æ—Ä—É—É–ª—Å–∞–Ω “Ø–µ–¥ Upload-–∏–π–Ω “Ø—Ä –¥“Ø–Ω–≥ —É—Å—Ç–∞–≥ (—ç—Å–≤—ç–ª URL-–∏–π–≥ –∞—à–∏–≥–ª–∞–Ω–∞)
newsImageURLManual.addEventListener('input', () => {
    // –•—ç—Ä—ç–≤ —Ö—ç—Ä—ç–≥–ª—ç–≥—á –≥–∞—Ä–∞–∞—Ä URL –æ—Ä—É—É–ª–±–∞–ª, –±–∏–¥ “Ø“Ø–Ω–∏–π–≥ “Ø–Ω–¥—Å—ç–Ω —É—Ç–≥–∞ –±–æ–ª–≥–æ–Ω–æ.
    newsImage.value = newsImageURLManual.value.trim();
    previewImage.style.display = 'none'; // Upload-–∏–π–Ω preview-–≥ –Ω—É—É–Ω–∞
    uploadStatus.textContent = '(–ì–∞—Ä–∞–∞—Ä URL –æ—Ä—É—É–ª—Å–∞–Ω)';
    uploadStatus.style.color = 'blue';
});


// ---------------------------------------------------
// AUTH FUNCTIONS (–ù—ç–≤—Ç—Ä—ç—Ö / –ì–∞—Ä–∞—Ö)
// ---------------------------------------------------

async function checkAuthAndRenderUI() {
    const { data: { user } } = await supabaseClient.auth.getUser();

    if (user) {
        // –ù—ç–≤—Ç—ç—Ä—Å—ç–Ω
        loginFormContainer.style.display = 'none';
        adminContent.style.display = 'grid';
        logoutButton.style.display = 'block';
        initializeAdminPanel(); 
    } else {
        // –ù—ç–≤—Ç—Ä—ç—ç–≥“Ø–π
        loginFormContainer.style.display = 'block';
        adminContent.style.display = 'none';
        logoutButton.style.display = 'none';
    }
}

async function handleLogin() {
    loginError.textContent = '';
    const email = loginEmail.value.trim();
    const password = loginPassword.value.trim();

    if (!email || !password) {
        loginError.textContent = "–ò-–º—ç–π–ª –±–æ–ª–æ–Ω –Ω—É—É—Ü “Ø–≥ –∑–∞–∞–≤–∞–ª –±”©–≥–ª”©–Ω”©.";
        return;
    }

    const { error } = await supabaseClient.auth.signInWithPassword({
        email: email,
        password: password,
    });

    if (error) {
        console.error("Login error:", error);
        loginError.textContent = "–ù—ç–≤—Ç—Ä—ç—Ö –Ω—ç—Ä —ç—Å–≤—ç–ª –Ω—É—É—Ü “Ø–≥ –±—É—Ä—É—É –±–∞–π–Ω–∞. (" + error.message + ")";
    } else {
        loginEmail.value = '';
        loginPassword.value = '';
        await checkAuthAndRenderUI();
    }
}

async function handleLogout() {
    if (confirm("–°–∏—Å—Ç–µ–º—ç—ç—Å –≥–∞—Ä–∞—Ö —É—É?")) {
        await supabaseClient.auth.signOut();
        await checkAuthAndRenderUI();
    }
}


// ---------------------------------------------------
// AUTH USERS (–ó”©–≤—Ö”©–Ω Authors-–∏–π–≥ Auth Users-–∏–π–Ω –æ—Ä–æ–Ω–¥ —Ö–∞—Ä—É—É–ª—ä—è)
// ---------------------------------------------------

async function displayAuthUsers() {
    const list = await fetchAuthors(); 
    authUsersList.innerHTML = "";

    if (!list.length) { 
        authUsersList.innerHTML = "<p>–°–∏—Å—Ç–µ–º–¥ —Ö—ç—Ä—ç–≥–ª—ç–≥—á/–Ω–∏–π—Ç–ª—ç–ª—á –±–∞–π—Ö–≥“Ø–π. –î—ç—ç—Ä—Ö —Ç–æ–≤—á–æ–æ—Ä –Ω—ç–º–Ω—ç “Ø“Ø.</p>"; 
        return; 
    }
    
    authUsersList.innerHTML = `<div style="margin-top: 10px;">` + list.map(a => `
        <div class="list-item">
            <span>${a.name} (ID: ${a.id})</span>
            <span>
                <button onclick="alert('–≠–Ω—ç—Ö“Ø“Ø —Ñ—É–Ω–∫—Ü –Ω—å –∑”©–≤—Ö”©–Ω Auth ID-–∞–∞—Ä –∞–∂–∏–ª–ª–∞—Ö —ë—Å—Ç–æ–π.')">–£–¥–∏—Ä–¥–∞—Ö</button>
            </span>
        </div>
    `).join("") + `</div>`;
}


async function openAddUserModal() {
    const email = prompt("–®–∏–Ω—ç —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –∏-–º—ç–π–ª:");
    if (!email) return;
    const password = prompt("–®–∏–Ω—ç —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –Ω—É—É—Ü “Ø–≥:");
    if (!password) return;

    // Supabase Auth-–¥ –±“Ø—Ä—Ç–≥—ç–Ω—ç
    const { error } = await supabaseClient.auth.signUp({
        email: email,
        password: password,
        options: {
            emailRedirectTo: window.location.origin
        }
    });

    if (error) {
        alert("–•—ç—Ä—ç–≥–ª—ç–≥—á –Ω—ç–º—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: " + error.message);
    } else {
        alert(`–•—ç—Ä—ç–≥–ª—ç–≥—á ${email} –∞–º–∂–∏–ª—Ç—Ç–∞–π –Ω—ç–º—ç–≥–¥–ª—ç—ç. –•—ç—Ä—ç–≤ Email Confirmation –∏–¥—ç–≤—Ö—Ç—ç–π –±–æ–ª, –∏-–º—ç–π–ª—ç—ç —à–∞–ª–≥–∞–Ω–∞ —É—É.`);
        displayAuthUsers();
    }
}


// ---------------------------------------------------
// SLUG GENERATION FUNCTION
// ---------------------------------------------------

function cyrillicToLatin(text) {
    const cyrToLat = {
        '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'ye', '—ë': 'yo', '–∂': 'j', '–∑': 'z', '–∏': 'i', '–π': 'i',
        '–∫': 'k', '–ª': 'l', '–º': 'm', '–Ω': 'n', '–æ': 'o', '”©': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u',
        '“Ø': 'u', '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch', '—à': 'sh', '—â': 'sh', '—ä': '', '—ã': 'i', '—å': '',
        '—ç': 'e', '—é': 'yu', '—è': 'ya', '–ê': 'A', '–ë': 'B', 'V': 'V', '–ì': 'G', '–î': 'D', '–ï': 'Ye', '–Å': 'Yo',
        '–ñ': 'J', '–ó': 'Z', '–ò': 'I', '–ô': 'I', '–ö': 'K', '–õ': 'L', '–ú': '–ú', '–ù': '–ù', '–û': 'O', '”®': 'O',
        '–ü': 'P', '–†': 'R', '–°': 'S', '–¢': 'T', '–£': 'U', '“Æ': 'U', '–§': 'F', '–•': 'H', '–¶': 'Ts', '–ß': 'Ch',
        '–®': 'Sh', '–©': 'Sh', '–™': '', '–´': 'I', '–¨': '', '–≠': 'E', '–Æ': 'Yu', '–Ø': 'Ya'
    };

    let result = '';
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        result += cyrToLat[char] || char;
    }
    return result;
}

function generateSlug(title) {
    let slug = cyrillicToLatin(title);
    slug = slug.toLowerCase();
    slug = slug.replace(/\s+/g, '-');
    slug = slug.replace(/[^\w-]+/g, '');
    slug = slug.replace(/--+/g, '-');
    slug = slug.replace(/^-+|-+$/g, '');
    
    return slug;
}


// ---------------------------------------------------
// AUTHORS (“Æ–Ω–¥—Å—ç–Ω –ª–æ–≥–∏–∫—É—É–¥)
// ---------------------------------------------------
async function fetchAuthors() {
    const { data } = await supabaseClient.from("authors").select("*").order("id");
    return data || [];
}

async function populateAuthorSelect() {
    const list = await fetchAuthors();
    newsAuthor.innerHTML = list.length
        ? list.map(a => `<option value="${a.id}">${a.name}</option>`).join("")
        : `<option disabled>–ù–∏–π—Ç–ª—ç–ª—á –±–∞–π—Ö–≥“Ø–π</option>`;
}

async function displayAuthors() {
    const list = await fetchAuthors();
    authorList.innerHTML = list.length
        ? list.map(a => `
            <div class="list-item">
                <span>${a.name} (${a.title})</span>
                <span>
                    <button onclick="editAuthor(${a.id})">–ó–∞—Å–∞—Ö</button>
                    <button onclick="removeAuthor(${a.id})">–£—Å—Ç–≥–∞—Ö</button>
                </span>
            </div>
        `).join("")
        : "–ù–∏–π—Ç–ª—ç–ª—á –±–∞–π—Ö–≥“Ø–π";
}

async function saveAuthor() {
    const data = {
        name: authorName.value.trim(),
        title: authorTitle.value.trim(),
        image: authorImage.value.trim()
    };
    if (!data.name) return alert("–ù—ç—Ä –∑–∞–∞–≤–∞–ª –±”©–≥–ª”©–Ω”©");

    if (editAuthorIndex.value === "")
        await supabaseClient.from("authors").insert(data);
    else
        await supabaseClient.from("authors").update(data).eq("id", editAuthorIndex.value);

    clearAuthorForm();
    populateAuthorSelect();
    displayAuthors();
    displayAuthUsers();
}

async function editAuthor(id) {
    const { data } = await supabaseClient.from("authors").select("*").eq("id", id).single();
    editAuthorIndex.value = data.id;
    authorName.value = data.name;
    authorTitle.value = data.title;
    authorImage.value = data.image;
}

async function removeAuthor(id) {
    if (confirm("–£—Å—Ç–≥–∞—Ö —É—É?")) {
        await supabaseClient.from("authors").delete().eq("id", id);
        populateAuthorSelect();
        displayAuthors();
        displayAuthUsers();
    }
}

function clearAuthorForm() {
    editAuthorIndex.value = "";
    authorName.value = "";
    authorTitle.value = "";
    authorImage.value = "";
}

// ---------------------------------------------------
// NEWS (“Æ–Ω–¥—Å—ç–Ω –ª–æ–≥–∏–∫—É—É–¥)
// ---------------------------------------------------
async function fetchNews() {
    const { data } = await supabaseClient.from("news").select("*").order("created_at", { ascending: false });
    return data || [];
}

async function displayNews(filter = "") {
    const news = await fetchNews();
    const authors = await fetchAuthors();
    newsList.innerHTML = "";

    let filteredNews = news;
    if (filter) {
        filteredNews = news.filter(n => n.title.toLowerCase().includes(filter.toLowerCase()));
    }

    if (!filteredNews.length) { newsList.innerHTML = "–ú—ç–¥—ç—ç –±–∞–π—Ö–≥“Ø–π"; return; }

    const grouped = {};
    filteredNews.forEach(n => {
        const day = n.created_at ? n.created_at.split("T")[0] : "–û–≥–Ω–æ–æ –±–∞–π—Ö–≥“Ø–π";
        if (!grouped[day]) grouped[day] = [];
        grouped[day].push(n);
    });

    for (const d in grouped) {
        newsList.innerHTML += `<div class="group-title">${d}</div>`;
        grouped[d].forEach(n => {
            const aut = authors.find(a => a.id == n.author_id)?.name || "–¢–æ–¥–æ—Ä—Ö–æ–π–≥“Ø–π";
            const activeStatus = n.active ? " (–ò–¥—ç–≤—Ö—Ç—ç–π)" : " (–ù–æ–æ—Ä–æ–≥)"; 
            
            const slugStatus = !n.slug || n.slug.length < 3 ? " ‚ö†Ô∏è SLUG –ê–õ–ì–ê/–ë–£–†–£–£" : "";
            const cardTypeDisplay = n.card_type ? ` | –¢”®–†”®–õ: ${n.card_type.toUpperCase()}` : "";


            newsList.innerHTML += `
            <div class="list-item">
                <span>${n.title} | ${n.category} | ${aut} ${n.featured ? " | –û–Ω—Ü–ª–æ—Ö" : ""}${cardTypeDisplay} ${activeStatus}${slugStatus}</span>
                <span>
                    <button onclick="editNews(${n.id})">–ó–∞—Å–∞—Ö</button>
                    <button onclick="removeNews(${n.id})">–£—Å—Ç–≥–∞—Ö</button>
                </span>
            </div>`;
        });
    }
}

async function saveNews() {
    const html = quill.root.innerHTML.trim();
    const titleValue = newsTitle.value.trim();
    
    // üí° newsImage.value –Ω—å upload —Ö–∏–π—Å—ç–Ω URL-–∏–π–≥ —ç—Å–≤—ç–ª –≥–∞—Ä–∞–∞—Ä –æ—Ä—É—É–ª—Å–∞–Ω URL-–∏–π–≥ –∞–≥—É—É–ª–Ω–∞.
    const imageURL = newsImage.value.trim();
    
    if (!titleValue) return alert("–ì–∞—Ä—á–∏–≥ –∑–∞–∞–≤–∞–ª –±”©–≥–ª”©–Ω”©");
    
    const data = {
        title: titleValue,
        slug: generateSlug(titleValue), 
        category: newsCategory.value || null,
        image: imageURL || null, // Upload —Ö–∏–π—Å—ç–Ω URL —ç—Å–≤—ç–ª null
        description: html || null,
        author_id: newsAuthor.value ? Number(newsAuthor.value) : null,
        featured: newsFeatured.checked,
        active: newsActive.checked,
        card_type: newsCardType.value || 'normal'
    };
    
    if (!data.author_id) return alert("–ù–∏–π—Ç–ª—ç–ª—á —Å–æ–Ω–≥–æ–Ω–æ —É—É");

    let result;
    if (editIndex.value === "") {
        result = await supabaseClient.from("news").insert(data);
    } else {
        result = await supabaseClient.from("news").update(data).eq("id", editIndex.value);
    }
    
    if (result.error) {
        console.error("News save error:", result.error);
        alert(`–ú—ç–¥—ç—ç —Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ${result.error.message}. Slug –¥–∞–≤—Ö–∞—Ä–¥—Å–∞–Ω —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞–Ω–∞ —É—É.`);
    } else {
        alert("–ú—ç–¥—ç—ç –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ö–∞–¥–≥–∞–ª–∞–≥–¥–ª–∞–∞.");
    }

    clearNewsForm();
    displayNews(searchInput.value);
}

async function editNews(id) {
    const { data } = await supabaseClient.from("news").select("*").eq("id", id).single();
    
    editIndex.value = data.id;
    newsTitle.value = data.title;
    newsCategory.value = data.category;
    
    // üí° –ó–∞—Å–∞—Ö “Ø–µ–¥ –∑—É—Ä–≥–∏–π–Ω URL-–∏–π–≥ –Ω—É—É—Ü –±–æ–ª–æ–Ω –≥–∞—Ä —Ç–∞–ª–±–∞—Ä—Ç –±”©–≥–ª”©–∂, Preview —Ö–∏–π—Ö
    const currentImage = data.image || "";
    newsImage.value = currentImage; // Hidden —Ç–∞–ª–±–∞—Ä
    newsImageURLManual.value = currentImage; // –ì–∞—Ä–∞–∞—Ä –æ—Ä—É—É–ª–∞—Ö —Ç–∞–ª–±–∞—Ä

    if (currentImage) {
        previewImage.src = currentImage;
        previewImage.style.display = 'block';
    } else {
        previewImage.style.display = 'none';
    }
    uploadStatus.textContent = ""; 
    imageUploadInput.value = ""; // Upload —Ç–∞–ª–±–∞—Ä—ã–≥ —Ü—ç–≤—ç—Ä–ª—ç—Ö

    newsAuthor.value = data.author_id;
    newsFeatured.checked = data.featured;
    newsActive.checked = data.active; 
    newsCardType.value = data.card_type || 'normal'; 
    quill.root.innerHTML = data.description;
}

async function removeNews(id) {
    if (confirm("–£—Å—Ç–≥–∞—Ö —É—É?")) {
        await supabaseClient.from("news").delete().eq("id", id);
        displayNews(searchInput.value);
    }
}

function clearNewsForm() {
    editIndex.value = "";
    newsTitle.value = "";
    newsCategory.value = "";
    
    // üí° Upload –±–æ–ª–æ–Ω Preview —Ö—ç—Å–≥–∏–π–≥ —Ü—ç–≤—ç—Ä–ª—ç—Ö
    newsImage.value = "";
    newsImageURLManual.value = ""; 
    previewImage.src = "";
    previewImage.style.display = 'none';
    uploadStatus.textContent = "";
    imageUploadInput.value = "";

    newsFeatured.checked = false;
    newsActive.checked = false; 
    newsCardType.value = 'normal'; 
    quill.setText("");
}

// Search listener
searchInput.addEventListener("input", () => {
    displayNews(searchInput.value);
});

// Global scope-–¥ —Ñ—É–Ω–∫—Ü—É—É–¥—ã–≥ –≥–∞—Ä–≥–∞—Ö (onclick “Ø–π–ª–¥—ç–ª –∞–∂–∏–ª–ª–∞—Ö—ã–Ω —Ç—É–ª–¥)
window.saveNews = saveNews;
window.clearNewsForm = clearNewsForm;
window.editNews = editNews;
window.removeNews = removeNews;
window.saveAuthor = saveAuthor;
window.clearAuthorForm = clearAuthorForm;
window.editAuthor = editAuthor;
window.removeAuthor = removeAuthor;
window.handleLogin = handleLogin;
window.handleLogout = handleLogout;
window.openAddUserModal = openAddUserModal;


// INIT
function initializeAdminPanel() {
    populateAuthorSelect();
    displayAuthors();
    displayNews();
    displayAuthUsers();
}

// –•—É—É–¥—Å—ã–≥ —ç—Ö–ª“Ø“Ø–ª—ç—Ö: –≠—Ö–ª—ç—ç–¥ Auth-–≥ —à–∞–ª–≥–∞–Ω–∞
checkAuthAndRenderUI();
</script>
</body>
</html>
