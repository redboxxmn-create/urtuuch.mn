<script>
// DOM —ç–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥
const newsTitle = document.getElementById("newsTitle");
const newsSlugInput = document.getElementById("newsSlugInput"); // –®–∏–Ω—ç—ç—Ä –Ω—ç–º—ç–≤
const newsCategory = document.getElementById("newsCategory");
const newsImage = document.getElementById("newsImage"); 
const newsCardType = document.getElementById("newsCardType"); 
const newsAuthor = document.getElementById("newsAuthor");
const newsFeatured = document.getElementById("newsFeatured");
const newsActive = document.getElementById("newsActive"); 
const newsList = document.getElementById("newsList");
const editIndex = document.getElementById("editIndex");

const authorName = document.getElementById("authorName");
const authorTitle = document.getElementById("authorTitle");
const authorImage = document.getElementById("authorImage");
const editAuthorIndex = document.getElementById("editAuthorIndex");
const authorList = document.getElementById("authorList");

const searchInput = document.getElementById("searchInput");

// –ù—ç–≤—Ç—Ä—ç—Ö —Ö—ç—Å–≥–∏–π–Ω DOM —ç–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const loginError = document.getElementById("loginError");
const loginFormContainer = document.getElementById("loginFormContainer");
const adminContent = document.getElementById("adminContent");
const logoutButton = document.getElementById("logoutButton");
const authUsersList = document.getElementById("authUsersList");

// –ó—É—Ä–∞–≥ Upload —Ö–∏–π—Ö DOM —ç–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥
const imageUploadInput = document.getElementById('imageUpload');
const uploadButton = document.getElementById('uploadButton');
const uploadStatus = document.getElementById('uploadStatus');
const previewImage = document.getElementById('previewImage');
const newsImageURLManual = document.getElementById('newsImageURLManual');

// Supabase client 
// –≠–ù–î –¢–ê–ù–´ SUPABASE –¢”®–°–õ–ò–ô–ù –ú–≠–î–≠–≠–õ–≠–õ –û–†–ù–û
const supabaseUrl = "https://wpotnvekaoosdkvmhqgo.supabase.co"; 
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indwb3RudmVrYW9vc2Rrdm1ocWdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTU3NjQsImV4cCI6MjA4MDU5MTc2NH0.YIpy_IA9nNseYUJB3Y-adxgv9btgAt5IKP5FJpafNC0";

const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey); 

// ===================================================
// Quill Editor Setup
// ===================================================
const AlignStyle = Quill.import('attributors/style/align');
AlignStyle.whitelist = ['right', 'center', 'justify']; 
Quill.register(AlignStyle, true);

const quill = new Quill("#editor", { 
    theme: "snow",
    modules: {
        toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'], 
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'align': [] }], 
            ['link', 'image'],
            ['clean']
        ]
    }
});

// ---------------------------------------------------
// SLUG GENERATION FUNCTION (”®”©—Ä—á–ª”©–≥–¥”©”©–≥“Ø–π, “Ø–Ω–¥—Å—ç–Ω —Ñ—É–Ω–∫—Ü)
// ---------------------------------------------------

function cyrillicToLatin(text) {
    const cyrToLat = {
        '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'ye', '—ë': 'yo', '–∂': 'j', '–∑': 'z', '–∏': 'i', '–π': 'i',
        '–∫': 'k', '–ª': 'l', '–º': 'm', '–Ω': 'n', '–æ': 'o', '”©': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u',
        '“Ø': 'u', '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch', '—à': 'sh', '—â': 'sh', '—ä': '', '—ã': 'i', '—å': '',
        '—ç': 'e', '—é': 'yu', '—è': 'ya', '–ê': 'A', '–ë': 'B', 'V': 'V', '–ì': 'G', '–î': 'D', '–ï': 'Ye', '–Å': 'Yo',
        '–ñ': 'J', '–ó': 'Z', '–ò': 'I', '–ô': 'I', '–ö': 'K', '–õ': 'L', '–ú': '–ú', '–ù': '–ù', '–û': 'O', '”®': 'O',
        '–ü': 'P', '–†': 'R', '–°': 'S', '–¢': 'T', '–£': 'U', '“Æ': 'U', '–§': 'F', '–•': 'H', '–¶': 'Ts', '–ß': 'Ch',
        '–®': 'Sh', '–©': 'Sh', '–™': '', '–´': 'I', '–¨': '', '–≠': 'E', '–Æ': 'Yu', '–Ø': 'Ya'
    };

    let result = '';
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        result += cyrToLat[char] || char;
    }
    return result;
}

function generateSlug(title) {
    let slug = cyrillicToLatin(title);
    slug = slug.toLowerCase();
    slug = slug.replace(/\s+/g, '-');
    slug = slug.replace(/[^\w-]+/g, '');
    slug = slug.replace(/--+/g, '-');
    slug = slug.replace(/^-+|-+$/g, '');
    
    return slug;
}

// ---------------------------------------------------
// üí° UNIQUE SLUG GENERATION FUNCTION
// ---------------------------------------------------
function generateUniqueSlug(title) {
    // –ó”©–≤—Ö”©–Ω —à–∏–Ω—ç –º—ç–¥—ç—ç –æ—Ä—É—É–ª–∞—Ö “Ø–µ–¥ (editIndex —Ö–æ–æ—Å–æ–Ω “Ø–µ–¥) —É–Ω–∏–∫–∞–ª ID –Ω—ç–º–Ω—ç
    if (editIndex.value === "") {
        const slug = generateSlug(title);
        // Date.now() –±–æ–ª–æ–Ω –∂–∏–∂–∏–≥ —Ç–æ—Ö–∏–æ–ª–¥–ª—ã–Ω –º”©—Ä–∏–π–≥ –Ω—ç–º–Ω—ç
        const uniquePart = Math.random().toString(36).substring(2, 6); 
        return `${slug}-${uniquePart}`; 
    } else {
        // –ó–∞—Å–≤–∞—Ä–ª–∞–∂ –±–∞–π–≥–∞–∞ –±–æ–ª, –æ–¥–æ–æ–≥–∏–π–Ω slug-–∏–π–≥ ”©”©—Ä—á–ª”©—Ö–≥“Ø–π
        return newsSlugInput.value;
    }
}

// ---------------------------------------------------
// DOM LISTENERS (Slug-–∏–π–≥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –±”©–≥–ª”©—Ö)
// ---------------------------------------------------
newsTitle.addEventListener('input', () => {
    // –ó”©–≤—Ö”©–Ω —à–∏–Ω—ç –º—ç–¥—ç—ç –æ—Ä—É—É–ª–∞—Ö “Ø–µ–¥ slug-–∏–π–≥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä “Ø“Ø—Å–≥—ç–Ω—ç.
    // –•—ç—Ä—ç–≤ –∑–∞—Å–≤–∞—Ä–ª–∞–∂ –±–∞–π–≥–∞–∞ –±–æ–ª, –º—ç–¥—ç—ç–Ω–∏–π –∞–Ω—Ö–Ω—ã slug-–∏–π–≥ —Ö–∞–¥–≥–∞–ª–Ω–∞.
    if (editIndex.value === "") {
        newsSlugInput.value = generateSlug(newsTitle.value);
    }
});


// ---------------------------------------------------
// IMAGE UPLOAD (Supabase Storage)
// ---------------------------------------------------

const BUCKET_NAME = 'news_images'; 

uploadButton.addEventListener('click', async () => {
    const file = imageUploadInput.files[0];
    if (!file) {
        uploadStatus.textContent = '–ó—É—Ä–∞–≥ —Å–æ–Ω–≥–æ–Ω–æ —É—É.';
        uploadStatus.style.color = 'red';
        return;
    }

    uploadStatus.textContent = '–ó—É—Ä–∞–≥ –æ—Ä—É—É–ª–∂ –±–∞–π–Ω–∞... (–•“Ø–ª—ç—ç–≥—ç—ç—Ä—ç–π)';
    uploadStatus.style.color = 'orange';
    newsImage.value = ''; 
    newsImageURLManual.value = ''; 

    const fileExtension = file.name.split('.').pop();
    // –§–∞–π–ª—ã–Ω –Ω—ç—Ä–∏–π–≥ unique –±–∞–π–ª–≥–∞—Ö
    const filePath = `news/${Date.now()}_${Math.random().toString(36).substring(2, 9)}.${fileExtension}`;

    try {
        const { error: uploadError } = await supabaseClient.storage
            .from(BUCKET_NAME)
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
            });

        if (uploadError) throw uploadError;

        const { data: publicURLData } = supabaseClient.storage
            .from(BUCKET_NAME)
            .getPublicUrl(filePath);

        const imageUrl = publicURLData.publicUrl;

        newsImage.value = imageUrl; 
        previewImage.src = imageUrl;
        previewImage.style.display = 'block';

        uploadStatus.textContent = '–ó—É—Ä–∞–≥ –∞–º–∂–∏–ª—Ç—Ç–∞–π –æ—Ä—É—É–ª–∞–≤!';
        uploadStatus.style.color = 'green';
        
    } catch (error) {
        console.error("–ó—É—Ä–∞–≥ –æ—Ä—É—É–ª–∞—Ö –∞–ª–¥–∞–∞:", error);
        uploadStatus.textContent = `–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ${error.message}. Storage-–∏–π–Ω —Ç–æ—Ö–∏—Ä–≥–æ–æ–≥ —à–∞–ª–≥–∞–Ω–∞ —É—É.`;
        uploadStatus.style.color = 'red';
    }
});

newsImageURLManual.addEventListener('input', () => {
    newsImage.value = newsImageURLManual.value.trim();
    previewImage.style.display = 'none'; 
    uploadStatus.textContent = '(–ì–∞—Ä–∞–∞—Ä URL –æ—Ä—É—É–ª—Å–∞–Ω)';
    uploadStatus.style.color = 'blue';
});


// ---------------------------------------------------
// AUTH FUNCTIONS (–ù—ç–≤—Ç—Ä—ç—Ö / –ì–∞—Ä–∞—Ö) - ”®”©—Ä—á–ª”©–≥–¥”©”©–≥“Ø–π
// ---------------------------------------------------

async function checkAuthAndRenderUI() {
    const { data: { user } } = await supabaseClient.auth.getUser();

    if (user) {
        loginFormContainer.style.display = 'none';
        adminContent.style.display = 'grid';
        logoutButton.style.display = 'block';
        initializeAdminPanel(); 
    } else {
        loginFormContainer.style.display = 'block';
        adminContent.style.display = 'none';
        logoutButton.style.display = 'none';
    }
}

async function handleLogin() {
    loginError.textContent = '';
    const email = loginEmail.value.trim();
    const password = loginPassword.value.trim();

    if (!email || !password) {
        loginError.textContent = "–ò-–º—ç–π–ª –±–æ–ª–æ–Ω –Ω—É—É—Ü “Ø–≥ –∑–∞–∞–≤–∞–ª –±”©–≥–ª”©–Ω”©.";
        return;
    }

    const { error } = await supabaseClient.auth.signInWithPassword({
        email: email,
        password: password,
    });

    if (error) {
        console.error("Login error:", error);
        loginError.textContent = "–ù—ç–≤—Ç—Ä—ç—Ö –Ω—ç—Ä —ç—Å–≤—ç–ª –Ω—É—É—Ü “Ø–≥ –±—É—Ä—É—É –±–∞–π–Ω–∞. (" + error.message + ")";
    } else {
        loginEmail.value = '';
        loginPassword.value = '';
        await checkAuthAndRenderUI();
    }
}

async function handleLogout() {
    if (confirm("–°–∏—Å—Ç–µ–º—ç—ç—Å –≥–∞—Ä–∞—Ö —É—É?")) {
        await supabaseClient.auth.signOut();
        await checkAuthAndRenderUI();
    }
}

async function displayAuthUsers() {
    // –≠–Ω—ç —Ñ—É–Ω–∫—Ü –Ω—å Supabase auth.users-–∏–π–≥ —Ö–∞—Ä—É—É–ª–∞—Ö –ª–æ–≥–∏–∫—Ç–æ–π. 
    // –û–¥–æ–æ–≥–æ–æ—Ä Author-–∏–π–Ω –º—ç–¥—ç—ç–ª–ª–∏–π–≥ –∞—à–∏–≥–ª–∞–∂ –±–∞–π–Ω–∞.
    const list = await fetchAuthors(); 
    authUsersList.innerHTML = `–•—ç—Ä—ç–≥–ª—ç–≥—á–¥–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª (Author-–æ–æ—Ä) —Ö–∞—Ä–∞–≥–¥–∞—Ö –±–æ–ª–Ω–æ. –ù–∏–π—Ç: ${list.length}`;
    // ... “Æ–Ω–¥—Å—ç–Ω Auth user-–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç —Ö–∞—Ä—É—É–ª–∞—Ö –ª–æ–≥–∏–∫ —ç–Ω–¥ –Ω—ç–º—ç–≥–¥—ç–Ω—ç
}

async function openAddUserModal() {
    alert("–®–∏–Ω—ç Auth —Ö—ç—Ä—ç–≥–ª—ç–≥—á –Ω—ç–º—ç—Ö –º–æ–¥–∞–ª—å –Ω—ç—ç–≥–¥—ç—Ö –±–æ–ª–Ω–æ.");
    // ... –®–∏–Ω—ç —Ö—ç—Ä—ç–≥–ª—ç–≥—á –Ω—ç–º—ç—Ö –ª–æ–≥–∏–∫ —ç–Ω–¥ –Ω—ç–º—ç–≥–¥—ç–Ω—ç
}


// ---------------------------------------------------
// AUTHORS (–ù–∏–π—Ç–ª—ç–ª—á) - –î–£–¢–£–£ –ë–ê–ô–°–ê–ù –§–£–ù–ö–¶–£–£–î–´–ì –ù–≠–ú–≠–í
// ---------------------------------------------------

async function fetchAuthors() {
    const { data } = await supabaseClient.from("authors").select("*").order("id");
    return data || [];
}

async function populateAuthorSelect() {
    const list = await fetchAuthors();
    newsAuthor.innerHTML = list.length
        ? list.map(a => `<option value="${a.id}">${a.name}</option>`).join("")
        : `<option disabled>–ù–∏–π—Ç–ª—ç–ª—á –±–∞–π—Ö–≥“Ø–π</option>`;
}

async function displayAuthors() { // üëà –ù—ç–º—ç–≥–¥—Å—ç–Ω
    const list = await fetchAuthors();
    authorList.innerHTML = "";
    if (!list.length) { authorList.innerHTML = "–ù–∏–π—Ç–ª—ç–ª—á –±–∞–π—Ö–≥“Ø–π"; return; }
    
    list.forEach(a => {
        authorList.innerHTML += `
            <div class="list-item">
                <span>${a.name} (${a.title})</span>
                <span>
                    <button onclick="editAuthor(${a.id})">–ó–∞—Å–∞—Ö</button>
                    <button onclick="removeAuthor(${a.id})">–£—Å—Ç–≥–∞—Ö</button>
                </span>
            </div>`;
    });
}

async function saveAuthor() { // üëà –ù—ç–º—ç–≥–¥—Å—ç–Ω
    const nameValue = authorName.value.trim();
    const titleValue = authorTitle.value.trim();
    const imageValue = authorImage.value.trim();

    if (!nameValue) return alert("–ù–∏–π—Ç–ª—ç–ª—á–∏–π–Ω –Ω—ç—Ä–∏–π–≥ –±”©–≥–ª”©–Ω”© “Ø“Ø.");

    const data = {
        name: nameValue,
        title: titleValue || null,
        image: imageValue || null
    };

    let result;
    if (editAuthorIndex.value === "") {
        // –®–∏–Ω—ç –Ω–∏–π—Ç–ª—ç–ª—á
        result = await supabaseClient.from("authors").insert(data);
    } else {
        // –ù–∏–π—Ç–ª—ç–ª—á –∑–∞—Å–∞—Ö
        result = await supabaseClient.from("authors").update(data).eq("id", editAuthorIndex.value);
    }

    if (result.error) {
        console.error("Author save error:", result.error);
        alert(`–ù–∏–π—Ç–ª—ç–ª—á —Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ${result.error.message}`);
    } else {
        alert("–ù–∏–π—Ç–ª—ç–ª—á –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ö–∞–¥–≥–∞–ª–∞–≥–¥–ª–∞–∞.");
    }
    
    clearAuthorForm();
    populateAuthorSelect();
    displayAuthors();
}

function clearAuthorForm() { // üëà –ù—ç–º—ç–≥–¥—Å—ç–Ω
    editAuthorIndex.value = "";
    authorName.value = "";
    authorTitle.value = "";
    authorImage.value = "";
}

async function editAuthor(id) { // üëà –ù—ç–º—ç–≥–¥—Å—ç–Ω
    const { data } = await supabaseClient.from("authors").select("*").eq("id", id).single();
    
    editAuthorIndex.value = data.id;
    authorName.value = data.name;
    authorTitle.value = data.title;
    authorImage.value = data.image;
}

async function removeAuthor(id) { // üëà –ù—ç–º—ç–≥–¥—Å—ç–Ω
    if (confirm("–ù–∏–π—Ç–ª—ç–ª—á–∏–π–≥ —É—Å—Ç–≥–∞—Ö —É—É?")) {
        await supabaseClient.from("authors").delete().eq("id", id);
        populateAuthorSelect();
        displayAuthors();
    }
}


// ---------------------------------------------------
// NEWS (–ú—ç–¥—ç—ç) - ”®”©—Ä—á–ª”©–≥–¥”©”©–≥“Ø–π
// ---------------------------------------------------
async function fetchNews() {
    const { data } = await supabaseClient.from("news").select("*").order("created_at", { ascending: false });
    return data || [];
}

async function displayNews(filter = "") {
    const news = await fetchNews();
    const authors = await fetchAuthors();
    
    newsList.innerHTML = "";

    let filteredNews = news;
    if (filter) {
        filteredNews = news.filter(n => n.title.toLowerCase().includes(filter.toLowerCase()));
    }

    if (!filteredNews.length) { newsList.innerHTML = "–ú—ç–¥—ç—ç –±–∞–π—Ö–≥“Ø–π"; return; }

    const grouped = {};
    filteredNews.forEach(n => {
        const day = n.created_at ? n.created_at.split("T")[0] : "–û–≥–Ω–æ–æ –±–∞–π—Ö–≥“Ø–π";
        if (!grouped[day]) grouped[day] = [];
        grouped[day].push(n);
    });

    for (const d in grouped) {
        newsList.innerHTML += `<div class="group-title">${d}</div>`;
        grouped[d].forEach(n => {
            const aut = authors.find(a => a.id == n.author_id)?.name || "–¢–æ–¥–æ—Ä—Ö–æ–π–≥“Ø–π";
            const activeStatus = n.active ? " (–ò–¥—ç–≤—Ö—Ç—ç–π)" : " (–ù–æ–æ—Ä–æ–≥)"; 
            
            const slugStatus = !n.slug || n.slug.length < 3 ? " ‚ö†Ô∏è SLUG –ê–õ–ì–ê/–ë–£–†–£–£" : "";
            const cardTypeDisplay = n.card_type ? ` | –¢”®–†”®–õ: ${n.card_type.toUpperCase()}` : "";


            newsList.innerHTML += `
            <div class="list-item">
                <span>${n.title} | ${n.category} | ${aut} ${n.featured ? " | –û–Ω—Ü–ª–æ—Ö" : ""}${cardTypeDisplay} ${activeStatus}${slugStatus}</span>
                <span>
                    <button onclick="editNews(${n.id})">–ó–∞—Å–∞—Ö</button>
                    <button onclick="removeNews(${n.id})">–£—Å—Ç–≥–∞—Ö</button>
                </span>
            </div>`;
        });
    }
}

async function saveNews() {
    const html = quill.root.innerHTML.trim();
    const titleValue = newsTitle.value.trim();
    const imageURL = newsImage.value.trim();
    
    if (!titleValue) return alert("–ì–∞—Ä—á–∏–≥ –∑–∞–∞–≤–∞–ª –±”©–≥–ª”©–Ω”©");

    // UNIQUE SLUG-–∏–π–≥ “Ø“Ø—Å–≥—ç—Ö/–∞–≤–∞—Ö. –î–∞–≤—Ö–∞—Ä–¥–ª—ã–Ω –∞–ª–¥–∞–∞ –≥–∞—Ä–∞—Ö–≥“Ø–π.
    const slugValue = generateUniqueSlug(titleValue);
    
    const data = {
        title: titleValue,
        slug: slugValue, // üëà UNIQUE SLUG –∞—à–∏–≥–ª–∞–≤
        category: newsCategory.value || null,
        image: imageURL || null, 
        description: html || null,
        author_id: newsAuthor.value ? Number(newsAuthor.value) : null,
        featured: newsFeatured.checked,
        active: newsActive.checked,
        card_type: newsCardType.value || 'normal'
    };
    
    if (!data.author_id) return alert("–ù–∏–π—Ç–ª—ç–ª—á —Å–æ–Ω–≥–æ–Ω–æ —É—É");

    let result;
    if (editIndex.value === "") {
        // –®–∏–Ω—ç –º—ç–¥—ç—ç –æ—Ä—É—É–ª–∞—Ö
        result = await supabaseClient.from("news").insert(data);
    } else {
        // –ú—ç–¥—ç—ç –∑–∞—Å–∞—Ö
        // –ó–∞—Å–≤–∞—Ä–ª–∞—Ö “Ø–µ–¥ Slug-–∏–π–≥ update —Ö–∏–π—Ö–≥“Ø–π.
        const updateData = { ...data };
        delete updateData.slug; 
        
        result = await supabaseClient.from("news").update(updateData).eq("id", editIndex.value);
    }
    
    if (result.error) {
        console.error("News save error:", result.error);
        alert(`–ú—ç–¥—ç—ç —Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ${result.error.message}.`);
    } else {
        alert("–ú—ç–¥—ç—ç –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ö–∞–¥–≥–∞–ª–∞–≥–¥–ª–∞–∞.");
    }

    clearNewsForm();
    displayNews(searchInput.value);
}

async function editNews(id) {
    const { data } = await supabaseClient.from("news").select("*").eq("id", id).single();
    
    editIndex.value = data.id;
    newsTitle.value = data.title;
    newsSlugInput.value = data.slug; // Slug-–∏–π–≥ —Ç–∞–ª–±–∞—Ä—Ç —Ö–∞—Ä—É—É–ª–∞–≤
    newsCategory.value = data.category;
    
    const currentImage = data.image || "";
    newsImage.value = currentImage; 
    newsImageURLManual.value = currentImage; 

    if (currentImage) {
        previewImage.src = currentImage;
        previewImage.style.display = 'block';
    } else {
        previewImage.style.display = 'none';
    }
    uploadStatus.textContent = ""; 
    imageUploadInput.value = ""; 

    newsAuthor.value = data.author_id;
    newsFeatured.checked = data.featured;
    newsActive.checked = data.active; 
    newsCardType.value = data.card_type || 'normal'; 
    quill.root.innerHTML = data.description;
}

function clearNewsForm() {
    editIndex.value = "";
    newsTitle.value = "";
    newsSlugInput.value = ""; // Slug-–∏–π–≥ —Ü—ç–≤—ç—Ä–ª—ç–≤
    newsCategory.value = "";
    
    newsImage.value = "";
    newsImageURLManual.value = ""; 
    previewImage.src = "";
    previewImage.style.display = 'none';
    uploadStatus.textContent = "";
    imageUploadInput.value = "";

    newsFeatured.checked = false;
    newsActive.checked = false; 
    newsCardType.value = 'normal'; 
    quill.setText("");
}

async function removeNews(id) {
    if (confirm("–£—Å—Ç–≥–∞—Ö —É—É?")) {
        await supabaseClient.from("news").delete().eq("id", id);
        displayNews(searchInput.value);
    }
}

// Search listener
searchInput.addEventListener("input", () => {
    displayNews(searchInput.value);
});

// Global scope-–¥ —Ñ—É–Ω–∫—Ü—É—É–¥—ã–≥ –≥–∞—Ä–≥–∞—Ö (onClick “Ø–π–ª–¥–ª“Ø“Ø–¥ –∑”©–≤ –∞–∂–∏–ª–ª–∞—Ö—ã–Ω —Ç—É–ª–¥)
window.saveNews = saveNews;
window.clearNewsForm = clearNewsForm;
window.editNews = editNews;
window.removeNews = removeNews;

window.saveAuthor = saveAuthor; // üëà –ó”©–≤ —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–æ–≥–¥—Å–æ–Ω
window.clearAuthorForm = clearAuthorForm; // üëà –ó”©–≤ —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–æ–≥–¥—Å–æ–Ω
window.editAuthor = editAuthor; // üëà –ó”©–≤ —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–æ–≥–¥—Å–æ–Ω
window.removeAuthor = removeAuthor; // üëà –ó”©–≤ —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–æ–≥–¥—Å–æ–Ω

window.handleLogin = handleLogin;
window.handleLogout = handleLogout;
window.openAddUserModal = openAddUserModal;


// INIT
function initializeAdminPanel() {
    populateAuthorSelect();
    displayAuthors(); // üëà –û–¥–æ–æ —ç–Ω—ç —Ñ—É–Ω–∫—Ü —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–æ–≥–¥—Å–æ–Ω
    displayNews();
    displayAuthUsers();
}

// –•—É—É–¥—Å—ã–≥ —ç—Ö–ª“Ø“Ø–ª—ç—Ö: –≠—Ö–ª—ç—ç–¥ Auth-–≥ —à–∞–ª–≥–∞–Ω–∞
checkAuthAndRenderUI();
</script>
