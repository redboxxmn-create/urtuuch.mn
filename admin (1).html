<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª (–•—É—É–¥–∞—Å–ª–∞–ª—Ç—Ç–∞–π)</title>

    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        body { font-family: 'Ubuntu', sans-serif; background: #f4f6f8; margin: 0; padding: 0; }
        header { 
            background: #3d85c6; 
            color: #fff; 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .container { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        input, select { width: 100%; padding: 8px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { padding: 8px 15px; margin-right: 5px; border: none; border-radius: 8px; cursor: pointer; background: #6fa8dc; color: #fff; transition: background 0.3s; }
        button:hover { background: #3d85c6; }
        button:disabled { background: #ccc; cursor: not-allowed; } /* –•—É—É–¥–∞—Å–ª–∞–ª—Ç—ã–Ω —Ç–æ–≤—á–∏–π–≥ –∏–¥—ç–≤—Ö–≥“Ø–π –±–æ–ª–≥–æ—Ö CSS */
        
        #logoutButton {
            background: #ff5252;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: #fff;
            transition: background 0.3s;
        }
        #logoutButton:hover {
            background: #e04040;
        }
        
        .list-item { padding: 8px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        #editor { height: 150px; }
        .group-title { font-weight: bold; margin-top: 20px; color: #3d85c6; border-bottom: 2px solid #3d85c6; padding-bottom: 5px; }
        .search-input { margin-bottom: 10px; padding: 8px; width: 100%; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;}
        .checkbox-group { display: flex; gap: 20px; margin: 10px 0; }
        #imageUpload { padding: 4px; height: auto; }

        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
            .card { grid-column: span 1 !important; }
        }
    </style>
</head>
<body>

<header>
    <h1>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª</h1>
    <button id="logoutButton" onclick="handleLogout()" style="display: none;">–ì–∞—Ä–∞—Ö</button>
</header>

<div id="loginFormContainer">
    <div class="card" style="max-width: 400px; margin: 50px auto; text-align: center;">
        <h2>–ê–¥–º–∏–Ω –ù—ç–≤—Ç—Ä—ç—Ö</h2>
        <input id="loginEmail" type="email" placeholder="–ò-–º—ç–π–ª" required>
        <input id="loginPassword" type="password" placeholder="–ù—É—É—Ü “Ø–≥" required>
        <button onclick="handleLogin()">–ù—ç–≤—Ç—Ä—ç—Ö</button>
        <p id="loginError" style="color: red; margin-top: 10px;"></p>
    </div>
</div>

<div class="container" id="adminContent" style="display: none;">

    <div class="card">
        <h2>–ú—ç–¥—ç—ç –Ω—ç–º—ç—Ö / –∑–∞—Å–∞—Ö</h2>
        <input type="hidden" id="editIndex">
        <input id="newsTitle" placeholder="–ì–∞—Ä—á–∏–≥">
        <input id="newsSlugInput" placeholder="Slug (–ê–≤—Ç–æ–º–∞—Ç–∞–∞—Ä “Ø“Ø—Å–Ω—ç)" style="margin-top: 0px;" readonly> 

        <select id="newsCategory">
            <option value="">–ê–Ω–≥–∏–ª–∞–ª</option>
            <option>–£–ª—Å —Ç”©—Ä</option>
            <option>–≠–¥–∏–π–Ω –∑–∞—Å–∞–≥</option>
            <option>–°–æ—ë–ª —É—Ä–ª–∞–≥</option>
            <option>–ú–µ–¥–∏–∞</option>
            <option>–î—ç–ª—Ö–∏–π –¥–∞—Ö–∏–Ω–¥</option>
            <option>–Ø—Ä–∏–ª—Ü–ª–∞–≥–∞</option>
        </select>
        
        <div style="margin: 10px 0;">
            <label for="imageUpload">–ó—É—Ä–∞–≥ —Å–æ–Ω–≥–æ—Ö:</label>
            <input type="file" id="imageUpload" accept="image/*" style="padding: 4px; height: auto;">
            <button id="uploadButton" type="button" style="background: #2ecc71;">–ó—É—Ä–∞–≥ –æ—Ä—É—É–ª–∞—Ö</button>
            <div id="uploadStatus" style="font-size: 12px; margin-top: 5px;"></div>
            <img id="previewImage" src="" style="max-width: 150px; height: auto; margin-top: 10px; border-radius: 8px; display: none;">
            
            <input type="hidden" id="newsImage" value=""> 
            
            <input type="text" id="newsImageURLManual" placeholder="–≠—Å–≤—ç–ª –ó—É—Ä–∞–≥ URL-–∏–π–≥ –≥–∞—Ä–∞–∞—Ä –æ—Ä—É—É–ª–Ω–∞ —É—É" style="margin-top: 10px;">
        </div>

        <input type="text" id="newsVideoLink" placeholder="YouTube –í–∏–¥–µ–æ –õ–∏–Ω–∫ (–ë“Ø—Ç—ç–Ω URL: https://www.youtube.com/watch?v=...)">


        <select id="newsCardType">
            <option value="normal">–≠–Ω–≥–∏–π–Ω –º—ç–¥—ç—ç (Normal)</option>
            <option value="sub_featured">–î—ç–¥ –æ–Ω—Ü–ª–æ—Ö (Sub-Featured)</option>
            <option value="featured_large">–û–Ω—Ü–ª–æ—Ö –¢–æ–º –ö–∞—Ä—Ç (Featured Large)</option>
        </select>
        <div id="editor"></div>
        <select id="newsAuthor"></select>
        
        <div class="checkbox-group">
            <label><input type="checkbox" id="newsFeatured"> –û–Ω—Ü–ª–æ—Ö</label>
            <label><input type="checkbox" id="newsActive"> –ò–¥—ç–≤—Ö—Ç—ç–π / –ù–∏–π—Ç–ª—ç—Ö</label> 
        </div>
        
        <button onclick="saveNews()">–•–∞–¥–≥–∞–ª–∞—Ö</button>
        <button onclick="clearNewsForm()">–¶—ç–≤—ç—Ä–ª—ç—Ö</button>
    </div>

    <div class="card">
        <h2>–ù–∏–π—Ç–ª—ç–ª—á</h2>
        <input type="hidden" id="editAuthorIndex">
        <input id="authorName" placeholder="–ù—ç—Ä">
        <input id="authorTitle" placeholder="–ê–ª–±–∞–Ω —Ç—É—à–∞–∞–ª">
        <input id="authorImage" placeholder="–ó—É—Ä–∞–≥">
        <button onclick="saveAuthor()">–•–∞–¥–≥–∞–ª–∞—Ö</button>
        <button onclick="clearAuthorForm()">–¶—ç–≤—ç—Ä–ª—ç—Ö</button>
    </div>

    <div class="card" style="grid-column: span 2;">
        <h2>–°–∏—Å—Ç–µ–º–∏–π–Ω –•—ç—Ä—ç–≥–ª—ç–≥—á–∏–¥ (Supabase Auth)</h2>
        <button onclick="openAddUserModal()">+ –•—ç—Ä—ç–≥–ª—ç–≥—á –ù—ç–º—ç—Ö</button>
        <div id="authUsersList"></div>
    </div>
    
    <div class="card" style="grid-column: span 2;">
        <input type="text" id="searchInput" class="search-input" placeholder="–ú—ç–¥—ç—ç —Ö–∞–π—Ö...">
    </div>

    <div class="card" style="grid-column: span 2;">
        <h2>–ú—ç–¥—ç—ç</h2>
        <div id="newsList"></div>
    </div>

    <div class="card" style="grid-column: span 2;">
        <h2>–ù–∏–π—Ç–ª—ç–ª—á–∏–¥</h2>
        <div id="authorList"></div>
    </div>

</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 

<script>
// ===================================================
// GLOBAL CONFIG & VARIABLES
// ===================================================

// –•—É—É–¥–∞—Å–ª–∞–ª—Ç—ã–Ω —Ö—É–≤—å—Å–∞–≥—á—É—É–¥ 
let currentPage = 1; 
const newsPerPage = 30; // –ù—ç–≥ —Ö—É—É–¥—Å–∞–Ω–¥ —Ö–∞—Ä—É—É–ª–∞—Ö –º—ç–¥—ç—ç–Ω–∏–π —Ç–æ–æ

// DOM —ç–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥
const newsTitle = document.getElementById("newsTitle");
const newsSlugInput = document.getElementById("newsSlugInput");
const newsCategory = document.getElementById("newsCategory");
const newsImage = document.getElementById("newsImage"); 
const newsCardType = document.getElementById("newsCardType"); 
const newsAuthor = document.getElementById("newsAuthor");
const newsFeatured = document.getElementById("newsFeatured");
const newsActive = document.getElementById("newsActive"); 
const newsList = document.getElementById("newsList");
const editIndex = document.getElementById("editIndex");

const authorName = document.getElementById("authorName");
const authorTitle = document.getElementById("authorTitle");
const authorImage = document.getElementById("authorImage");
const editAuthorIndex = document.getElementById("editAuthorIndex");
const authorList = document.getElementById("authorList");

const searchInput = document.getElementById("searchInput");

// –ù—ç–≤—Ç—Ä—ç—Ö —Ö—ç—Å–≥–∏–π–Ω DOM —ç–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const loginError = document.getElementById("loginError");
const loginFormContainer = document.getElementById("loginFormContainer");
const adminContent = document.getElementById("adminContent");
const logoutButton = document.getElementById("logoutButton");
const authUsersList = document.getElementById("authUsersList");

// –ó—É—Ä–∞–≥ Upload —Ö–∏–π—Ö DOM —ç–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥
const imageUploadInput = document.getElementById('imageUpload');
const uploadButton = document.getElementById('uploadButton');
const uploadStatus = document.getElementById('uploadStatus');
const previewImage = document.getElementById('previewImage');
const newsImageURLManual = document.getElementById('newsImageURLManual');

const newsVideoLink = document.getElementById("newsVideoLink");


// Supabase client 
const supabaseUrl = "https://wpotnvekaoosdkvmhqgo.supabase.co"; 
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indwb3RudmVrYW9vc2Rrdm1ocWdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTU3NjQsImV4cCI6MjA4MDU5MTc2NH0.YIpy_IA9nNseYUJB3Y-adxgv9btgAt5IKP5FJpafNC0";

const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey); 
const BUCKET_NAME = 'news_images'; 

// ===================================================
// Quill Editor Setup
// ===================================================
const AlignStyle = Quill.import('attributors/style/align');
AlignStyle.whitelist = ['right', 'center', 'justify']; 
Quill.register(AlignStyle, true);

const quill = new Quill("#editor", { 
    theme: "snow",
    modules: {
        toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'], 
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'align': [] }], 
            ['link', 'image'],
            ['clean']
        ]
    }
});

// ---------------------------------------------------
// SLUG GENERATION FUNCTIONS
// ---------------------------------------------------

function cyrillicToLatin(text) {
    const cyrToLat = {
        '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'ye', '—ë': 'yo', '–∂': 'j', '–∑': 'z', '–∏': 'i', '–π': 'i',
        '–∫': 'k', '–ª': 'l', '–º': 'm', '–Ω': 'n', '–æ': 'o', '”©': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u',
        '“Ø': 'u', '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch', '—à': 'sh', '—â': 'sh', '—ä': '', '—ã': 'i', '—å': '',
        '—ç': 'e', '—é': 'yu', '—è': 'ya', '–ê': 'A', '–ë': 'B', 'V': 'V', '–ì': 'G', '–î': 'D', '–ï': 'Ye', '–Å': 'Yo',
        '–ñ': 'J', '–ó': 'Z', '–ò': 'I', '–ô': 'I', '–ö': 'K', '–õ': 'L', '–ú': '–ú', '–ù': '–ù', '–û': 'O', '”®': 'O',
        '–ü': 'P', '–†': 'R', '–°': 'S', '–¢': 'T', '–£': 'U', '“Æ': 'U', '–§': 'F', '–•': 'H', '–¶': 'Ts', '–ß': 'Ch',
        '–®': 'Sh', '–©': 'Sh', '–™': '', '–´': 'I', '–¨': '', '–≠': 'E', '–Æ': 'Yu', '–Ø': 'Ya'
    };

    let result = '';
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        result += cyrToLat[char] || char;
    }
    return result;
}

function generateSlug(title) {
    let slug = cyrillicToLatin(title);
    slug = slug.toLowerCase();
    slug = slug.replace(/\s+/g, '-');
    slug = slug.replace(/[^\w-]+/g, '');
    slug = slug.replace(/--+/g, '-');
    slug = slug.replace(/^-+|-+$/g, '');
    
    return slug;
}

function generateUniqueSlug(title) {
    if (editIndex.value === "") {
        const slug = generateSlug(title);
        const uniquePart = Math.random().toString(36).substring(2, 6); 
        return `${slug}-${uniquePart}`; 
    } else {
        return newsSlugInput.value;
    }
}

// DOM LISTENERS (Slug-–∏–π–≥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –±”©–≥–ª”©—Ö)
newsTitle.addEventListener('input', () => {
    if (editIndex.value === "") {
        newsSlugInput.value = generateSlug(newsTitle.value);
    }
});


// ---------------------------------------------------
// ZUURAG UPLOAD LOGIC 
// ---------------------------------------------------
async function handleImageUpload() {
    const file = imageUploadInput.files[0];
    if (!file) {
        uploadStatus.textContent = '–ó—É—Ä–∞–≥ —Å–æ–Ω–≥–æ–Ω–æ —É—É.';
        uploadStatus.style.color = 'red';
        return;
    }

    uploadStatus.textContent = '–ó—É—Ä–∞–≥ –æ—Ä—É—É–ª–∂ –±–∞–π–Ω–∞... (–•“Ø–ª—ç—ç–≥—ç—ç—Ä—ç–π)';
    uploadStatus.style.color = 'orange';
    newsImage.value = ''; 
    newsImageURLManual.value = ''; 
    newsVideoLink.value = ''; 

    const fileExtension = file.name.split('.').pop();
    const uniqueFileName = `${Date.now()}_${Math.random().toString(36).substring(2, 9)}.${fileExtension}`;
    const filePath = uniqueFileName; 

    try {
        const { error: uploadError } = await supabaseClient.storage
            .from(BUCKET_NAME)
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
            });

        if (uploadError) throw uploadError;

        const { data: publicURLData } = supabaseClient.storage
            .from(BUCKET_NAME)
            .getPublicUrl(filePath);

        const imageUrl = publicURLData.publicUrl;

        newsImage.value = imageUrl; 
        previewImage.src = imageUrl;
        previewImage.style.display = 'block';

        uploadStatus.textContent = '–ó—É—Ä–∞–≥ –∞–º–∂–∏–ª—Ç—Ç–∞–π –æ—Ä—É—É–ª–∞–≤!';
        uploadStatus.style.color = 'green';
        
    } catch (error) {
        console.error("–ó—É—Ä–∞–≥ –æ—Ä—É—É–ª–∞—Ö –∞–ª–¥–∞–∞:", error);
        uploadStatus.textContent = `–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ${error.message}. Storage Policy-–≥ —à–∞–ª–≥–∞–Ω–∞ —É—É (INSERT, authenticated/anon).`;
        uploadStatus.style.color = 'red';
    }
}
uploadButton.addEventListener('click', handleImageUpload);

newsImageURLManual.addEventListener('input', () => {
    newsImage.value = newsImageURLManual.value.trim();
    if(newsImage.value) {
        previewImage.src = newsImage.value;
        previewImage.style.display = 'block'; 
        uploadStatus.textContent = '(–ì–∞—Ä–∞–∞—Ä URL –æ—Ä—É—É–ª—Å–∞–Ω)';
        uploadStatus.style.color = 'blue';
    } else {
        previewImage.style.display = 'none'; 
        uploadStatus.textContent = '';
    }
    imageUploadInput.value = ''; 
});


// ---------------------------------------------------
// AUTH FUNCTIONS (–ù—ç–≤—Ç—Ä—ç—Ö / –ì–∞—Ä–∞—Ö)
// ---------------------------------------------------

async function checkAuthAndRenderUI() {
    const { data: { user } } = await supabaseClient.auth.getUser();

    if (user) {
        loginFormContainer.style.display = 'none';
        adminContent.style.display = 'grid';
        logoutButton.style.display = 'block';
        initializeAdminPanel(); 
    } else {
        loginFormContainer.style.display = 'block';
        adminContent.style.display = 'none';
        logoutButton.style.display = 'none';
    }
}

async function handleLogin() {
    loginError.textContent = '';
    const email = loginEmail.value.trim();
    const password = loginPassword.value.trim();

    if (!email || !password) {
        loginError.textContent = "–ò-–º—ç–π–ª –±–æ–ª–æ–Ω –Ω—É—É—Ü “Ø–≥ –∑–∞–∞–≤–∞–ª –±”©–≥–ª”©–Ω”©.";
        return;
    }

    const { error } = await supabaseClient.auth.signInWithPassword({
        email: email,
        password: password,
    });

    if (error) {
        console.error("Login error:", error);
        loginError.textContent = "–ù—ç–≤—Ç—Ä—ç—Ö –Ω—ç—Ä —ç—Å–≤—ç–ª –Ω—É—É—Ü “Ø–≥ –±—É—Ä—É—É –±–∞–π–Ω–∞. (" + error.message + ")";
    } else {
        loginEmail.value = '';
        loginPassword.value = '';
        await checkAuthAndRenderUI();
    }
}

async function handleLogout() {
    if (confirm("–°–∏—Å—Ç–µ–º—ç—ç—Å –≥–∞—Ä–∞—Ö —É—É?")) {
        await supabaseClient.auth.signOut();
        await checkAuthAndRenderUI();
    }
}

async function displayAuthUsers() {
    const list = await fetchAuthors(); 
    authUsersList.innerHTML = `–°–∏—Å—Ç–µ–º–∏–π–Ω —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–¥ (–ù–∏–π—Ç–ª—ç–ª—á–¥–∏–π–Ω —Ç–æ–æ): ${list.length}`;
}

async function openAddUserModal() {
    alert("–®–∏–Ω—ç Auth —Ö—ç—Ä—ç–≥–ª—ç–≥—á –Ω—ç–º—ç—Ö –º–æ–¥–∞–ª—å –Ω—ç—ç–≥–¥—ç—Ö –±–æ–ª–Ω–æ.");
}


// ---------------------------------------------------
// AUTHORS (–ù–∏–π—Ç–ª—ç–ª—á) - –ë“Æ–†–≠–ù –§–£–ù–ö–¶–£–£–î
// ---------------------------------------------------

async function fetchAuthors() {
    const { data } = await supabaseClient.from("authors").select("*").order("id");
    return data || [];
}

async function populateAuthorSelect() {
    const list = await fetchAuthors();
    newsAuthor.innerHTML = `<option value="">--- –ù–∏–π—Ç–ª—ç–ª—á –°–æ–Ω–≥–æ—Ö ---</option>` + list
        .map(a => `<option value="${a.id}">${a.name}</option>`)
        .join("");
}

async function displayAuthors() { 
    const list = await fetchAuthors();
    authorList.innerHTML = "";
    if (!list.length) { authorList.innerHTML = "–ù–∏–π—Ç–ª—ç–ª—á –±–∞–π—Ö–≥“Ø–π"; return; }
    
    list.forEach(a => {
        authorList.innerHTML += `
            <div class="list-item">
                <span>${a.name} (${a.title})</span>
                <span>
                    <button onclick="editAuthor(${a.id})">–ó–∞—Å–∞—Ö</button>
                    <button onclick="removeAuthor(${a.id})">–£—Å—Ç–≥–∞—Ö</button>
                </span>
            </div>`;
    });
}

async function saveAuthor() { 
    const nameValue = authorName.value.trim();
    const titleValue = authorTitle.value.trim();
    const imageValue = authorImage.value.trim();

    if (!nameValue) return alert("–ù–∏–π—Ç–ª—ç–ª—á–∏–π–Ω –Ω—ç—Ä–∏–π–≥ –±”©–≥–ª”©–Ω”© “Ø“Ø.");

    const data = {
        name: nameValue,
        title: titleValue || null,
        image: imageValue || null
    };

    let result;
    if (editAuthorIndex.value === "") {
        // –®–∏–Ω—ç –ù–∏–π—Ç–ª—ç–ª—á –ù—ç–º—ç—Ö
        result = await supabaseClient.from("authors").insert(data);
    } else {
        // –û–¥–æ–æ –±–∞–π–≥–∞–∞–≥ –ó–∞—Å–∞—Ö
        result = await supabaseClient.from("authors").update(data).eq("id", editAuthorIndex.value);
    }

    if (result.error) {
        console.error("Author save error:", result.error);
        alert(`–ù–∏–π—Ç–ª—ç–ª—á —Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ${result.error.message}. (RLS Policy-–≥ —à–∞–ª–≥–∞–Ω–∞ —É—É)`);
    } else {
        alert("–ù–∏–π—Ç–ª—ç–ª—á –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ö–∞–¥–≥–∞–ª–∞–≥–¥–ª–∞–∞.");
    }
    
    clearAuthorForm();
    populateAuthorSelect();
    displayAuthors(); 
}

function clearAuthorForm() { 
    editAuthorIndex.value = "";
    authorName.value = "";
    authorTitle.value = "";
    authorImage.value = "";
}

async function editAuthor(id) { 
    const { data } = await supabaseClient.from("authors").select("*").eq("id", id).single();
    
    editAuthorIndex.value = data.id;
    authorName.value = data.name;
    authorTitle.value = data.title;
    authorImage.value = data.image;
}

async function removeAuthor(id) { 
    if (confirm("–ù–∏–π—Ç–ª—ç–ª—á–∏–π–≥ —É—Å—Ç–≥–∞—Ö —É—É?")) {
        const { error } = await supabaseClient.from("authors").delete().eq("id", id);
        if (error) {
            alert(`–£—Å—Ç–≥–∞—Ö “Ø–µ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ${error.message}. –≠–Ω—ç –Ω–∏–π—Ç–ª—ç–ª—á–∏–π–≥ –∞—à–∏–≥–ª–∞—Å–∞–Ω –º—ç–¥—ç—ç –±–∞–π–≥–∞–∞ —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞–Ω–∞ —É—É.`);
        }
        populateAuthorSelect();
        displayAuthors();
    }
}


// ---------------------------------------------------
// NEWS (–ú—ç–¥—ç—ç) - –•–£–£–î–ê–°–õ–ê–õ–¢–¢–ê–ô
// ---------------------------------------------------

/**
 * –ú—ç–¥—ç—ç–≥ Supabase-–∞–∞—Å —Ç–∞—Ç–∞–∂ –∞–≤–Ω–∞. count: 'exact' –∞—à–∏–≥–ª–∞–Ω –Ω–∏–π—Ç —Ç–æ–æ–≥ –∞–≤–Ω–∞.
 */
async function fetchNews(page = currentPage, limit = newsPerPage) {
    const start = (page - 1) * limit;
    const end = start + limit - 1; // Supabase range –Ω—å —Ç”©–≥—Å–≥”©–ª–∏–π–Ω index-–∏–π–≥ –æ—Ä—É—É–ª–¥–∞–≥

    const { data, count, error } = await supabaseClient.from("news")
        .select("*, video_link", { count: 'exact' }) 
        .order("created_at", { ascending: false })
        .range(start, end); // RANGE –ê–®–ò–ì–õ–ê–ñ –ë–ê–ô–ù–ê

    if (error) {
        console.error("Fetching news error:", error);
        return { data: [], totalCount: 0 };
    }
    
    return { data: data || [], totalCount: count || 0 };
}


function shareOnFacebook(slug) {
    // ‚ö†Ô∏è –¢–∞–Ω—ã “Ø–Ω–¥—Å—ç–Ω –¥–æ–º–∞–π–Ω URL-–∏–π–≥ —ç–Ω–¥ –∑–∞–∞–≤–∞–ª –∑”©–≤ –æ—Ä—É—É–ª–∞—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π!
    const BASE_URL = 'https://urtuuch.mn/news/?slug='; 
    const newsUrl = BASE_URL + slug;

    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(newsUrl)}`;

    window.open(facebookUrl, 'facebook-share-dialog', 'width=800,height=600');
}

/**
 * –ú—ç–¥—ç—ç–≥ –¥—ç–ª–≥—ç—Ü—ç–Ω–¥ —Ö–∞—Ä—É—É–ª–∂, —Ö—É—É–¥–∞—Å–ª–∞–ª—Ç—ã–Ω —Ç–æ–≤—á–ª—É—É—Ä—ã–≥ “Ø“Ø—Å–≥—ç–Ω—ç.
 */
async function displayNews(filter = "") {
    
    let newsData, totalCount;
    
    // –•—ç—Ä—ç–≤ —Ö–∞–π–ª—Ç —Ö–∏–π–≥—ç—ç–≥“Ø–π –±–æ–ª —Ö—É—É–¥–∞—Å–ª–∞–ª—Ç –∞—à–∏–≥–ª–∞–Ω–∞.
    if (!filter) {
        const result = await fetchNews(currentPage, newsPerPage);
        newsData = result.data;
        totalCount = result.totalCount;
    } else {
        // –•—ç—Ä—ç–≤ —Ö–∞–π–ª—Ç —Ö–∏–π–∂ –±–∞–π–≤–∞–ª, –±“Ø—Ö –º—ç–¥—ç—ç–≥ —Ç–∞—Ç–∞–∂, JS-—ç—ç—Ä —à“Ø“Ø—Ö (–•–∞–π–ª—Ç–∞–¥ Pagination —Ö–∏–π—Ö–≥“Ø–π)
        const allNews = await fetchNews(1, 99999); 
        newsData = allNews.data; 
    }

    const authors = await fetchAuthors();
    
    newsList.innerHTML = "";

    let filteredNews = newsData;

    // –•–∞–π–ª—Ç—ã–Ω —à“Ø“Ø–ª—Ç“Ø“Ø—Ä
    if (filter) {
        filteredNews = newsData.filter(n => n.title.toLowerCase().includes(filter.toLowerCase()) || 
                                             n.slug?.toLowerCase().includes(filter.toLowerCase()));
        totalCount = filteredNews.length; // –•–∞–π–ª—Ç—ã–Ω “Ø—Ä –¥“Ø–Ω–≥–∏–π–Ω —Ç–æ–æ
    }

    if (!filteredNews.length) { newsList.innerHTML = "–ú—ç–¥—ç—ç –±–∞–π—Ö–≥“Ø–π"; return; }

    const grouped = {};
    filteredNews.forEach(n => {
        const day = n.created_at ? n.created_at.split("T")[0] : "–û–≥–Ω–æ–æ –±–∞–π—Ö–≥“Ø–π";
        if (!grouped[day]) grouped[day] = [];
        grouped[day].push(n);
    });

    for (const d in grouped) {
        newsList.innerHTML += `<div class="group-title">${d}</div>`;
        grouped[d].forEach(n => {
            const aut = authors.find(a => a.id == n.author_id)?.name || "–¢–æ–¥–æ—Ä—Ö–æ–π–≥“Ø–π";
            const activeStatus = n.active ? " (–ò–¥—ç–≤—Ö—Ç—ç–π)" : " (–ù–æ–æ—Ä–æ–≥)"; 
            
            const slugStatus = !n.slug || n.slug.length < 3 ? " ‚ö†Ô∏è SLUG –ê–õ–ì–ê/–ë–£–†–£–£" : "";
            const cardTypeDisplay = n.card_type ? ` | –¢”®–†”®–õ: ${n.card_type.toUpperCase()}` : "";
            const videoStatus = n.video_link ? " | üìπ –í–ò–î–ï–û" : "";


            newsList.innerHTML += `
            <div class="list-item">
                <span>${n.title} | ${n.category} | ${aut} ${n.featured ? " | –û–Ω—Ü–ª–æ—Ö" : ""}${cardTypeDisplay} ${videoStatus} ${activeStatus}${slugStatus}</span>
                <span>
                    <button onclick="shareOnFacebook('${n.slug}')" style="background: #4267B2;">üöÄ –®—ç–π—Ä–ª—ç—Ö</button>
                    <button onclick="editNews(${n.id})">–ó–∞—Å–∞—Ö</button>
                    <button onclick="removeNews(${n.id})">–£—Å—Ç–≥–∞—Ö</button>
                </span>
            </div>`;
        });
    }
    
    // ---------------------------------------------------
    // üí° PAGINATION BUTTONS (–•—É—É–¥–∞—Å–ª–∞–ª—Ç—ã–Ω –¢–æ–≤—á–ª—É—É—Ä—É—É–¥)
    // ---------------------------------------------------
    if (!filter) { // –•–∞–π–ª—Ç —Ö–∏–π–≥—ç—ç–≥“Ø–π “Ø–µ–¥ –ª —Ö—É—É–¥–∞—Å–ª–∞–ª—Ç —Ö–∞—Ä—É—É–ª–Ω–∞
        const totalPages = Math.ceil(totalCount / newsPerPage);
        
        let paginationHTML = `<div style="text-align:center; padding: 15px; margin-top: 20px;">
                                <p>–ù–∏–π—Ç –º—ç–¥—ç—ç: ${totalCount} | –•—É—É–¥–∞—Å: ${currentPage}/${totalPages}</p>`;

        // ”®–º–Ω”©—Ö —Ö—É—É–¥–∞—Å
        paginationHTML += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Üê ”®–º–Ω”©—Ö</button>`;
        
        // –û–¥–æ–æ–≥–∏–π–Ω —Ö—É—É–¥–∞—Å
        paginationHTML += `<span style="padding: 0 15px; font-weight: bold;"> ${currentPage} </span>`;

        // –î–∞—Ä–∞–∞–≥–∏–π–Ω —Ö—É—É–¥–∞—Å
        paginationHTML += `<button onclick="changePage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>–î–∞—Ä–∞–∞–≥–∏–π–Ω ‚Üí</button>`;
        
        paginationHTML += `</div>`;
        
        newsList.innerHTML += paginationHTML;
    }
}


function changePage(newPage) {
    const totalPages = Math.ceil(newsList.querySelector('p').textContent.split('/')[1].split(' ')[0] / newsPerPage);
    if (newPage > 0 && newPage <= totalPages) {
        currentPage = newPage;
        displayNews(searchInput.value); 
        window.scrollTo(0, 0); 
    } else if (newPage > 0 && currentPage < totalPages) {
         // –≠–Ω—ç –Ω—å —Ö–∞–º–≥–∏–π–Ω —Å“Ø“Ø–ª–∏–π–Ω —Ö—É—É–¥–∞—Å –±–∞–π—Ö –º–∞–≥–∞–¥–ª–∞–ª—Ç–∞–π.
        currentPage = newPage;
        displayNews(searchInput.value); 
        window.scrollTo(0, 0); 
    }
}

async function saveNews() {
    const html = quill.root.innerHTML.trim();
    const titleValue = newsTitle.value.trim();
    const imageURL = newsImage.value.trim();
    const videoLinkValue = newsVideoLink.value.trim(); 
    
    if (!titleValue) return alert("–ì–∞—Ä—á–∏–≥ –∑–∞–∞–≤–∞–ª –±”©–≥–ª”©–Ω”©");

    const slugValue = editIndex.value === "" ? generateUniqueSlug(titleValue) : newsSlugInput.value;
    
    const data = {
        title: titleValue,
        slug: slugValue, 
        category: newsCategory.value || null,
        image: imageURL || null, 
        video_link: videoLinkValue || null, 
        description: html || null,
        author_id: newsAuthor.value ? Number(newsAuthor.value) : null,
        featured: newsFeatured.checked,
        active: newsActive.checked,
        card_type: newsCardType.value || 'normal'
    };
    
    if (!data.author_id) return alert("–ù–∏–π—Ç–ª—ç–ª—á —Å–æ–Ω–≥–æ–Ω–æ —É—É");

    let result;
    if (editIndex.value === "") {
        // –®–∏–Ω—ç –º—ç–¥—ç—ç –æ—Ä—É—É–ª–∞—Ö
        result = await supabaseClient.from("news").insert(data);
    } else {
        // –ú—ç–¥—ç—ç –∑–∞—Å–∞—Ö
        const updateData = { ...data };
        delete updateData.slug; 
        
        result = await supabaseClient.from("news").update(updateData).eq("id", editIndex.value);
    }
    
    if (result.error) {
        console.error("News save error:", result.error);
        alert(`–ú—ç–¥—ç—ç —Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ${result.error.message}.`);
    } else {
        alert("–ú—ç–¥—ç—ç –∞–º–∂–∏–ª—Ç—Ç–∞–π —Ö–∞–¥–≥–∞–ª–∞–≥–¥–ª–∞–∞.");
    }

    clearNewsForm();
    // –•—É—É–¥—Å—ã–≥ –¥–∞—Ö–∏–Ω –∞—á–∞–∞–ª–∞—Ö–¥–∞–∞ 1-—Ä —Ö—É—É–¥–∞—Å –¥—ç—ç—Ä –±—É—Ü–∞–∞–Ω–∞ (–®–∏–Ω—ç –º—ç–¥—ç—ç —ç—Ö—ç–Ω–¥ –≥–∞—Ä–Ω–∞).
    currentPage = 1; 
    displayNews(searchInput.value);
}

async function editNews(id) {
    const { data } = await supabaseClient.from("news").select("*").eq("id", id).single();
    
    editIndex.value = data.id;
    newsTitle.value = data.title;
    newsSlugInput.value = data.slug; 
    newsCategory.value = data.category;
    
    const currentImage = data.image || "";
    newsImage.value = currentImage; 
    newsImageURLManual.value = currentImage; 

    if (currentImage) {
        previewImage.src = currentImage;
        previewImage.style.display = 'block';
    } else {
        previewImage.style.display = 'none';
    }
    uploadStatus.textContent = ""; 
    imageUploadInput.value = ""; 

    newsVideoLink.value = data.video_link || ""; 

    newsAuthor.value = data.author_id;
    newsFeatured.checked = data.featured;
    newsActive.checked = data.active; 
    newsCardType.value = data.card_type || 'normal'; 
    quill.root.innerHTML = data.description;
    
    window.scrollTo(0, 0); // –•—É—É–¥—Å—ã–≥ –¥—ç—ç—à –≥“Ø–π–ª–≥—ç—Ö
}

function clearNewsForm() {
    editIndex.value = "";
    newsTitle.value = "";
    newsSlugInput.value = ""; 
    newsCategory.value = "";
    
    newsImage.value = "";
    newsImageURLManual.value = ""; 
    newsVideoLink.value = ""; 

    previewImage.src = "";
    previewImage.style.display = 'none';
    uploadStatus.textContent = "";
    imageUploadInput.value = "";

    newsFeatured.checked = false;
    newsActive.checked = false; 
    newsCardType.value = 'normal'; 
    quill.setText("");
}

async function removeNews(id) {
    if (confirm("–£—Å—Ç–≥–∞—Ö —É—É?")) {
        const { error } = await supabaseClient.from("news").delete().eq("id", id);
        if(error) {
            alert(`–£—Å—Ç–≥–∞—Ö “Ø–µ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: ${error.message}`);
        }
        // –£—Å—Ç–≥–∞—Å–Ω—ã –¥–∞—Ä–∞–∞ —Ö—É—É–¥—Å—ã–≥ –¥–∞—Ö–∏–Ω –∞—á–∞–∞–ª–Ω–∞.
        displayNews(searchInput.value);
    }
}

// Search listener
searchInput.addEventListener("input", () => {
    // –•–∞–π–ª—Ç —Ö–∏–π—Ö “Ø–µ–¥ pagination-–∏–π–≥ –∞–ª–≥–∞ –±–æ–ª–≥–æ–Ω–æ.
    displayNews(searchInput.value);
});

// Global scope-–¥ —Ñ—É–Ω–∫—Ü—É—É–¥—ã–≥ –≥–∞—Ä–≥–∞—Ö (HTML-–∏–π–Ω onclick “Ø–π–ª–¥–ª“Ø“Ø–¥ –∞–∂–∏–ª–ª–∞—Ö—ã–Ω —Ç—É–ª–¥)
window.saveNews = saveNews;
window.clearNewsForm = clearNewsForm;
window.editNews = editNews;
window.removeNews = removeNews;
window.shareOnFacebook = shareOnFacebook; 

window.saveAuthor = saveAuthor; 
window.clearAuthorForm = clearAuthorForm; 
window.editAuthor = editAuthor; 
window.removeAuthor = removeAuthor; 

window.handleLogin = handleLogin;
window.handleLogout = handleLogout;
window.openAddUserModal = openAddUserModal;
window.changePage = changePage; // –®–∏–Ω—ç—ç—Ä –Ω—ç–º—ç–≥–¥—Å—ç–Ω


// INIT
function initializeAdminPanel() {
    populateAuthorSelect();
    displayAuthors(); 
    currentPage = 1; // “Æ—Ä–≥—ç–ª–∂ 1-—Ä —Ö—É—É–¥–∞—Å–Ω–∞–∞—Å —ç—Ö–ª“Ø“Ø–ª–Ω—ç
    displayNews();
    displayAuthUsers();
}

// –•—É—É–¥—Å—ã–≥ —ç—Ö–ª“Ø“Ø–ª—ç—Ö: –≠—Ö–ª—ç—ç–¥ Auth-–≥ —à–∞–ª–≥–∞–Ω–∞
checkAuthAndRenderUI();
</script>
</body>
</html>
