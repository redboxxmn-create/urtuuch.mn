<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ Панел</title>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body { font-family: 'Ubuntu', sans-serif; background: #f4f6f8; margin: 0; padding: 0; }
        header { background: #3d85c6; color: #fff; padding: 15px 20px; }
        .container { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
        input, select { width: 100%; padding: 8px; margin: 8px 0; border-radius: 8px; box-sizing: border-box; }
        .list-item { padding: 8px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; }
        #editor { height: 150px; }
        .group-title { font-weight: bold; margin-top: 20px; color: #3d85c6; }
        .checkbox-group { display: flex; gap: 20px; margin: 10px 0; }
    </style>
</head>
<body>
<header><h1>Админ Панел</h1></header>
<div class="container">
    <div class="card">
        <h2>Мэдээ нэмэх / засах</h2>
        <input type="hidden" id="editIndex">
        <input id="newsTitle" placeholder="Гарчиг">
        <select id="newsCategory">
            <option value="">Ангилал</option>
            <option>Улс төр</option>
            <option>Эдийн засаг</option>
            <option>Соёл урлаг</option>
            <option>Медиа</option>
            <option>Дэлхий дахинд</option>
            <option>Ярилцлага</option>
        </select>
        <input id="newsImage" placeholder="Зураг URL">
        <div id="editor"></div>
        <select id="newsAuthor"></select>
        
        <div class="checkbox-group">
            <label>
                <input type="checkbox" id="newsFeatured"> Онцлох
            </label>
            <label>
                <input type="checkbox" id="newsActive" checked> Нийтлэх (Active)
            </label>
        </div>
        
        <button onclick="saveNews()">Хадгалах</button>
        <button onclick="clearNewsForm()">Цэвэрлэх</button>
    </div>
    <div class="card">
        <h2>Нийтлэлч</h2>
        <input type="hidden" id="editAuthorIndex">
        <input id="authorName" placeholder="Нэр">
        <input id="authorTitle" placeholder="Албан тушаал">
        <input id="authorImage" placeholder="Зураг">
        <button onclick="saveAuthor()">Хадгалах</button>
        <button onclick="clearAuthorForm()">Цэвэрлэх</button>
    </div>
    <div class="card" style="grid-column:span 2;">
        <h2>Мэдээ</h2>
        <div id="newsList"></div>
    </div>
    <div class="card" style="grid-column:span 2;">
        <h2>Нийтлэлчид</h2>
        <div id="authorList"></div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script type="module">
// ⚠️ Энэ нь admin.html-д алдаа үүсгэж байсан client-ийг зөв импортлох арга юм.
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

// ======================================================<br>
// DOM ЭЛЕМЕНТҮҮДИЙГ БАТАЛГААТААР АВАХ
// ======================================================<br>
const newsTitle = document.getElementById("newsTitle");
const newsCategory = document.getElementById("newsCategory");
const newsImage = document.getElementById("newsImage");
const newsAuthor = document.getElementById("newsAuthor");
const newsFeatured = document.getElementById("newsFeatured");
// ✅ ШИНЭ ЭЛЕМЕНТ
const newsActive = document.getElementById("newsActive");

const newsList = document.getElementById("newsList");
const editIndex = document.getElementById("editIndex");
const authorName = document.getElementById("authorName");
const authorTitle = document.getElementById("authorTitle");
const authorImage = document.getElementById("authorImage");
const editAuthorIndex = document.getElementById("editAuthorIndex");
const authorList = document.getElementById("authorList");

// ======================================================<br>
// SUPABASE CLIENT ЗӨВ АШИГЛАХ
// ======================================================<br>
// ⚠️ Та энд YOUR_PUBLIC_ANON_KEY_HERE-г өөрийн түлхүүрээр солино уу.
const SUPABASE_URL = "https://wpotnvekaoosdkvmhqgo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indwb3RudmVrYW9vc2Rrdm1ocWdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTU3NjQsImV4cCI6MjA4MDU5MTc2NH0.YIpy_IA9nNseYUJB3Y-adxgv9btgAt5IKP5FJpafNC0";

const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


// ======================================================<br>
// QUILL EDITOR
// ======================================================<br>
const quill = new Quill("#editor", { theme: "snow" });

// ======================================================<br>
// AUTHORS
// ======================================================<br>
async function fetchAuthors() {
    let { data, error } = await supabaseClient.from("authors").select("*").order("id");
    if(error) console.error("Authors fetch error:", error);
    return data || [];
}
async function populateAuthorSelect() {
    const list = await fetchAuthors();
    if (list.length === 0) { newsAuthor.innerHTML = `<option disabled>Нийтлэлч байхгүй</option>`; return; }
    // Эхний option-г 'Сонгох' гэж үлдээв
    newsAuthor.innerHTML = `<option value="">Нийтлэлч сонгох</option>` + list.map(a => `<option value="${a.id}">${a.name}</option>`).join("");
}
async function displayAuthors() {
    const list = await fetchAuthors();
    authorList.innerHTML = list.length === 0 ? "Нийтлэлч байхгүй" : "";
    authorList.innerHTML = list.map(a => `<br>
        <div class='list-item'><br>
            <span>${a.name} (${a.title})</span><br>
            <span><br>
                <button onclick='editAuthor(${a.id})'>Засах</button><br>
                <button onclick='removeAuthor(${a.id})'>Устгах</button><br>
            </span><br>
        </div><br>
    `).join("");
}
async function saveAuthor() {
    const data = { name: authorName.value.trim(), title: authorTitle.value.trim(), image: authorImage.value.trim() };
    if (!data.name) return alert("Нэр заавал бөглөнө");
    
    let result;
    if (editAuthorIndex.value === "") {
        result = await supabaseClient.from("authors").insert(data);
    } else {
        result = await supabaseClient.from("authors").update(data).eq("id", editAuthorIndex.value);
    }
    
    if (result.error) {
        console.error("Author save error:", result.error);
        alert("Нийтлэлч хадгалахад алдаа гарлаа. Консолыг шалгана уу.");
    } else {
        alert("Нийтлэлч амжилттай хадгалагдлаа.");
    }

    clearAuthorForm();
    populateAuthorSelect();
    displayAuthors();
}
async function editAuthor(id) {
    const { data } = await supabaseClient.from("authors").select("*").eq("id", id).single();
    editAuthorIndex.value = data.id;
    authorName.value = data.name;
    authorTitle.value = data.title;
    authorImage.value = data.image;
}
async function removeAuthor(id) { 
    if (confirm("Устгах уу?")) { 
        const { error } = await supabaseClient.from("authors").delete().eq("id", id);
        if (error) {
            console.error("Author delete error:", error);
            alert("Устгахад алдаа гарлаа. Консолыг шалгана уу.");
        } else {
            alert("Нийтлэлч амжилттай устгагдлаа.");
        }
        populateAuthorSelect(); 
        displayAuthors(); 
    } 
}
function clearAuthorForm() { editAuthorIndex.value = ""; authorName.value = ""; authorTitle.value = ""; authorImage.value = ""; }

// ======================================================<br>
// NEWS
// ======================================================<br>
async function fetchNews() {
    const { data, error } = await supabaseClient.from("news").select("*").order("created_at", { ascending: false });
    if(error) console.error("News fetch error:", error);
    return data || [];
}
async function displayNews() {
    const news = await fetchNews();
    const authors = await fetchAuthors(); // Зохиогчдыг дахин татаж авах
    newsList.innerHTML = "";
    if (news.length === 0) { newsList.innerHTML = "Мэдээ байхгүй"; return; }
    let grouped = {};
    // ✅ created_at null байх магадлалтайг тооцов
    news.forEach(n => { const day = n.created_at ? n.created_at.split("T")[0] : "Огноо байхгүй"; if (!grouped[day]) grouped[day] = []; grouped[day].push(n); });
    for (const d in grouped) {
        newsList.innerHTML += `<div class='group-title'>${d}</div>`;
        grouped[d].forEach(n => {
            const aut = authors.find(a => a.id == n.author_id)?.name || "Тодорхойгүй";
            // ✅ active/featured төлөвийг харуулав
            const status = `${n.featured ? " | Онцлох" : ""}${n.active ? " | Нийтлэгдсэн" : " | Ноорог"}`;

            newsList.innerHTML += `<div class='list-item'><br>
                <span>${n.title} | ${n.category} | ${aut} ${status}</span><br>
                <span><br>
                    <button onclick='editNews(${n.id})'>Засах</button><br>
                    <button onclick='removeNews(${n.id})'>Устгах</button><br>
                </span><br>
            </div>`;
        });
    }
}

// ✅ ГОЛ ЗАСВАР: active утгыг илгээж, алдааг засварлав.
async function saveNews() {
    const html = quill.root.innerHTML.trim();
    const data = {
        title: newsTitle.value.trim(),
        category: newsCategory.value || null, // Хоосон бол null илгээнэ
        image: newsImage.value.trim() || null,
        description: html || null,
        author_id: newsAuthor.value ? Number(newsAuthor.value) : null, // ✅ author_id-г тоон болгов, хоосон бол null
        featured: newsFeatured.checked,
        active: newsActive.checked // ✅ ШИНЭЭР НЭМСЭН: Нийтлэгдсэн эсэх
    };

    if (!data.title) return alert("Гарчиг заавал бөглөнө");
    if (!data.author_id) return alert("Нийтлэлч сонгоно уу");

    let result;
    if (editIndex.value === "") {
        result = await supabaseClient.from("news").insert(data);
    } else {
        result = await supabaseClient.from("news").update(data).eq("id", editIndex.value);
    }
    
    if (result.error) {
        console.error("News save error:", result.error);
        alert("Мэдээ хадгалахад алдаа гарлаа. Консолыг шалгана уу.");
    } else {
        alert("Мэдээ амжилттай хадгалагдлаа.");
    }
    
    clearNewsForm();
    displayNews();
}

// ... бусад функцууд өөрчлөгдөөгүй ...
async function editNews(id) {
    const { data } = await supabaseClient.from("news").select("*").eq("id", id).single();
    editIndex.value = data.id;
    newsTitle.value = data.title;
    newsCategory.value = data.category;
    newsImage.value = data.image;
    newsAuthor.value = data.author_id;
    newsFeatured.checked = data.featured;
    newsActive.checked = data.active; // ✅ active төлөвийг дуудна
    quill.root.innerHTML = data.description;
}
async function removeNews(id) { 
    if (confirm("Устгах уу?")) { 
        const { error } = await supabaseClient.from("news").delete().eq("id", id); 
        if (error) {
            console.error("News delete error:", error);
            alert("Устгахад алдаа гарлаа. Консолыг шалгана уу.");
        } else {
            alert("Мэдээ амжилттай устгагдлаа.");
        }
        displayNews(); 
    } 
}
function clearNewsForm() { 
    editIndex.value = ""; 
    newsTitle.value = ""; 
    newsCategory.value = ""; 
    newsImage.value = ""; 
    newsFeatured.checked = false; 
    newsActive.checked = true; // ✅ Шинэ мэдээг default-аар 'Нийтлэх' гэж тохируулна
    quill.setText(""); 
}

// ====================================================
// INIT
// ====================================================
window.saveNews = saveNews; // Global scope-т гаргав
window.editNews = editNews;
window.removeNews = removeNews;
window.clearNewsForm = clearNewsForm;
window.saveAuthor = saveAuthor;
window.editAuthor = editAuthor;
window.removeAuthor = removeAuthor;
window.clearAuthorForm = clearAuthorForm;

populateAuthorSelect();
displayAuthors();
displayNews();
</script>
</body>
</html>
